<!DOCTYPE html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartLab Chemical Inventory System</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
        body { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Sarabun', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #bae6fd 100%); min-height: 100%; line-height: 1.6; }
        * { box-sizing: border-box; }
        .container { max-width: 1200px; margin: 0 auto; padding: 16px; display: flex; flex-direction: column; min-height: 96vh; }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-box { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); padding: 40px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.15); width: 100%; max-width: 420px; border: 1px solid rgba(255, 255, 255, 0.3); }
        .logo-container { text-align: center; margin-bottom: 32px; }
        .logo { width: 80px; height: 80px; margin: 0 auto 16px; background: transparent; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 36px; box-shadow: none; }
        .logo img { width: 100%; height: 100%; object-fit: contain; border-radius: 20px; }
        h1 { color: #1f2937; margin: 0 0 8px 0; font-size: 26px; text-align: center; font-weight: 600; letter-spacing: -0.3px; }
        .subtitle { color: #6b7280; text-align: center; margin-bottom: 32px; font-size: 15px; line-height: 1.5; font-weight: 400; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #374151; font-weight: 500; font-size: 14px; }
        .input-wrapper { position: relative; }
        input[type="text"], input[type="password"], input[type="number"], select, textarea { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 15px; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); font-family: inherit; }
        input[type="password"] { padding-right: 48px; }
        .eye-icon { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 18px; color: #6b7280; user-select: none; transition: color 0.2s; }
        .eye-icon svg { width: 18px; height: 18px; }
        .eye-icon:hover { color: #374151; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #93c5fd; box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.1); background: white; }
        .btn { padding: 12px 24px; border: none; border-radius: 12px; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; font-family: inherit; position: relative; overflow: hidden; }
        .btn:before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; }
        .btn:hover:before { left: 100%; }
        .btn-primary { background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%); color: white; box-shadow: 0 4px 12px rgba(147, 197, 253, 0.3); width: 100%; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(147, 197, 253, 0.4); }
        .btn-secondary { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); color: #475569; border: 1px solid #e2e8f0; }
        .btn-secondary:hover { background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%); transform: translateY(-1px); }
        .btn-danger { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3); }
        .btn-danger:hover { background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%); transform: translateY(-1px); }
        .btn-success { background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3); }
        .btn-success:hover { background: linear-gradient(135deg, #047857 0%, #065f46 100%); transform: translateY(-1px); }
        .btn-small { padding: 8px 16px; font-size: 13px; margin: 0 4px; border-radius: 10px; }
        .error-message { background: #fef2f2; color: #dc2626; padding: 12px; border-radius: 10px; margin-bottom: 16px; font-size: 14px; text-align: center; border: 1px solid #fecaca; }
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        .header { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); padding: 20px 24px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; border: 1px solid rgba(255, 255, 255, 0.3); }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-logo { width: 48px; height: 48px; background: transparent; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: none; }
        .header-logo img { width: 100%; height: 100%; object-fit: contain; border-radius: 14px; }
        .header-info h2 { margin: 0; color: #1f2937; font-size: 22px; font-weight: 600; letter-spacing: -0.3px; }
        .header-info p { margin: 4px 0 0 0; color: #6b7280; font-size: 14px; font-weight: 400; }
        .header-right { display: flex; gap: 8px; align-items: center; }
        .nav-tabs { display: flex; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); padding: 8px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); border: 1px solid rgba(255, 255, 255, 0.3); }
        .nav-tab { padding: 10px 20px; border: none; background: transparent; color: #6b7280; font-size: 14px; font-weight: 500; cursor: pointer; border-radius: 12px; transition: all 0.3s ease; position: relative; overflow: hidden; font-family: inherit; flex-grow: 1; text-align: center; }
        .nav-tab:hover { background: rgba(147, 197, 253, 0.1); color: #60a5fa; }
        .nav-tab.active { background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%); color: white; box-shadow: 0 4px 12px rgba(147, 197, 253, 0.3); }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .stat-card { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); padding: 24px; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); border: 1px solid rgba(255, 255, 255, 0.3); transition: transform 0.3s ease; }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-card h3 { margin: 0 0 12px 0; color: #6b7280; font-size: 14px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card .number { font-size: 32px; font-weight: 700; color: #60a5fa; margin: 0; background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .card { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); padding: 24px; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); margin-bottom: 24px; border: 1px solid rgba(255, 255, 255, 0.3); }
        .card h3 { margin: 0 0 20px 0; color: #1f2937; font-size: 20px; font-weight: 600; letter-spacing: -0.3px; }
        .search-box { margin-bottom: 20px; }
        .search-box input { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 15px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); transition: all 0.3s ease; font-family: inherit; }
        .search-box input:focus { outline: none; border-color: #93c5fd; box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.1); background: white; }
        .table-container { overflow-x: auto; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.08); border: 1px solid rgba(255, 255, 255, 0.2); background: white; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 700px; background: white; font-size: 13px; border-radius: 16px; overflow: hidden; }
        th { background: #93c5fd; padding: 14px 12px; text-align: left; font-weight: 600; color: white; border: none; font-size: 13px; letter-spacing: 0.2px; position: relative; }
        th:first-child { border-top-left-radius: 16px; }
        th:last-child { border-top-right-radius: 16px; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; color: #475569; font-weight: 400; background: white; transition: all 0.2s ease; font-size: 13px; }
        tr:hover td { background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); transform: scale(1.001); }
        tr:last-child td { border-bottom: none; }
        tr:last-child td:first-child { border-bottom-left-radius: 16px; }
        tr:last-child td:last-child { border-bottom-right-radius: 16px; }
        .badge { display: inline-block; padding: 6px 12px; border-radius: 10px; font-size: 12px; font-weight: 500; letter-spacing: 0.25px; }
        .badge-low { background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); color: #dc2626; border: 1px solid #fecaca; }
        .badge-normal { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); color: #60a5fa; border: 1px solid #bfdbfe; }
        .badge-pending { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); color: #d97706; border: 1px solid #fed7aa; }
        .badge-returned { background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%); color: #a16207; border: 1px solid #fed7aa; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); z-index: 1000; overflow-y: auto; padding: 20px; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); padding: 32px; border-radius: 20px; max-width: 560px; width: 100%; max-height: 90%; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.15); border: 1px solid rgba(255, 255, 255, 0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-header h3 { margin: 0; color: #1f2937; font-size: 20px; font-weight: 600; letter-spacing: -0.3px; }
        .close-btn { background: rgba(107, 114, 128, 0.1); border: none; font-size: 20px; cursor: pointer; color: #6b7280; padding: 0; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 10px; transition: all 0.2s; }
        .close-btn:hover { background: rgba(107, 114, 128, 0.2); color: #374151; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .loading { text-align: center; padding: 20px; color: #6b7280; font-size: 14px; }
        .empty-state { text-align: center; padding: 40px 20px; color: #9ca3af; font-size: 14px; }
        .empty-state-icon { font-size: 48px; margin-bottom: 16px; }
        .academic-header { background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%); color: white; padding: 16px 24px; border-radius: 16px 16px 0 0; margin: -24px -24px 20px -24px; }
        .academic-header h3 { margin: 0; font-size: 18px; font-weight: 600; color: white; }
        .section-divider { height: 1px; background: linear-gradient(90deg, transparent, #e5e7eb, transparent); margin: 24px 0; }
        .info-box { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid #bfdbfe; padding: 16px; border-radius: 12px; margin-bottom: 20px; }
        .info-box p { margin: 0; color: #60a5fa; font-size: 14px; font-weight: 500; }
        @media (max-width: 768px) {
            .container { padding: 12px; }
            .form-row { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; gap: 16px; }
            .header { flex-direction: column; align-items: flex-start; padding: 16px 20px; }
            .header-right { width: 100%; justify-content: space-between; }
            .nav-tabs { overflow-x: auto; flex-wrap: nowrap; padding: 6px; gap: 6px; }
            .nav-tab { white-space: nowrap; padding: 8px 16px; font-size: 13px; flex-grow: 0; text-align: left; }
            .modal-content { padding: 24px; margin: 10px; }
            .login-box { padding: 32px 24px; margin: 10px; }
            h1 { font-size: 22px; }
            .card { padding: 20px; }
            table { min-width: 600px; }
            th, td { padding: 10px 6px; font-size: 12px; }
        }
        @media (max-width: 480px) {
            .btn-small { padding: 6px 12px; font-size: 12px; margin: 2px; }
            .stats-grid { gap: 12px; }
            .stat-card { padding: 20px; }
            .stat-card .number { font-size: 28px; }
        }
        .report-group-card { background: #fff; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; overflow: hidden; }
        .report-group-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; cursor: pointer; background: #f8fafc; transition: background 0.2s ease; }
        .report-group-header:hover { background: #f1f5f9; }
        .report-group-header h4 { margin: 0; color: #1f2937; font-size: 16px; display: flex; align-items: center; gap: 10px; }
        .report-group-header .stats { font-size: 13px; color: #6b7280; flex-shrink: 0; margin-left: 16px; }
        .report-group-header .toggle-icon { font-size: 20px; color: #60a5fa; font-weight: bold; transform: rotate(0deg); transition: transform 0.3s ease; }
        .report-group-header.open .toggle-icon { transform: rotate(90deg); }
        .report-group-details { display: none; padding: 0px; border-top: 1px solid #e5e7eb; background: #fff; }
        .report-group-details .table-container { box-shadow: none; border: none; border-radius: 0; }
        .report-group-details table th { background: #f0f9ff; color: #0c4a6e; }
        .page-footer { text-align: center; padding: 24px 0; margin-top: auto; color: #718096; font-size: 13px; font-weight: 500; border-top: 1px solid #cbd5e1; background-color: #f8fafc; border-radius: 12px; margin-left: -16px; margin-right: -16px; padding-left: 16px; padding-right: 16px; }
        
        /* ‚úÖ ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡πâ) */
        .btn-logout { transition: all 0.3s ease; }
        .btn-logout:hover {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            color: white !important;
            border: 1px solid #dc2626 !important;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
            transform: translateY(-1px);
        }

        /* ‚úÖ ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Welcome Toast */
        .welcome-toast {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%) translateY(-150%);
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            padding: 12px 28px 12px 20px; border-radius: 50px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.6);
            display: flex; align-items: center; gap: 16px; z-index: 9999;
            opacity: 0; transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); min-width: 300px;
        }
        .welcome-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .welcome-icon-circle { width: 44px; height: 44px; background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; box-shadow: 0 4px 12px rgba(96, 165, 250, 0.4); }
        .welcome-content { display: flex; flex-direction: column; }
        .welcome-title { font-family: 'Sarabun', sans-serif; font-size: 14px; color: #64748b; font-weight: 500; margin-bottom: 2px; }
        .welcome-name { font-family: 'Sarabun', sans-serif; font-size: 16px; color: #1e293b; font-weight: 700; }
  </style>

  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div id="app"></div>
  <script>
  // [IMPORTANT] ‡πÉ‡∏™‡πà URL Web App ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
  const API_URL = "https://script.google.com/macros/s/AKfycbxXd30mi6wPOKskw8A-yuUCwRf6YybXhqYdOotTg_i2Y5DhRvI7ZY-t3X7dMD_tCtkjUw/exec";

  async function callApi(action, payload = {}) {
    try {
      const response = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ action: action, data: payload }),
        headers: { "Content-Type": "text/plain;charset=utf-8" },
      });
      return await response.json();
    } catch (error) {
      console.error("API Error:", error);
      throw error;
    }
  }

  const SVG_EYE_SHOW = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-fill" viewBox="0 0 16 16"><path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/><path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/></svg>';
  const SVG_EYE_HIDE = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-slash-fill" viewBox="0 0 16 16"><path d="m10.79 12.912-1.614-1.615a3.5 3.5 0 0 1-4.474-4.474l-2.06-2.06C.938 6.278 0 8 0 8s3 5.5 8 5.5a7.029 7.029 0 0 0 2.79-.588zM5.21 3.088A7.028 7.028 0 0 1 8 2.5c5 0 8 5.5 8 5.5s-.939 1.721-2.641 3.238l-2.062-2.062a3.5 3.5 0 0 0-4.474-4.474L5.21 3.089z"/><path d="M5.525 7.646a2.5 2.5 0 0 0 2.829 2.829l-2.83-2.829zm4.95.708-2.829-2.83a2.5 2.5 0 0 1 2.829 2.829zm3.171 6-12-12 .708-.708 12 12-.708.708z"/></svg>';

  const defaultConfig = {
    system_title: '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ ‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£',
    logo_url: 'https://img5.pic.in.th/file/secure-sv1/-205c460e57efb3b52b.png',
    welcome_message: '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ'
  };
  let currentUser = null;
  let allData = [];
  let currentView = 'login';
  let currentTab = 'dashboard';

  let appElement;
  let modalElement;
  let loginButtonElement;
  let loginErrorElement;

  document.addEventListener('DOMContentLoaded', init);

  function init() {
    console.log('App initializing...');
    appElement = document.getElementById('app');
    
    // 1. ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å LocalStorage ‡∏Å‡πà‡∏≠‡∏ô
    const cachedData = localStorage.getItem('smartlab_local_data');
    
    if (cachedData) {
      try {
        allData = JSON.parse(cachedData);
        console.log('Loaded from Cache:', allData.length);
        initializeDefaultAdmin(); // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ Login ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        
        // ‡πÅ‡∏≠‡∏ö Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á
        callApi('sync')
          .then(response => {
            if (response.success && response.data) {
              allData = response.data;
              localStorage.setItem('smartlab_local_data', JSON.stringify(allData));
              if (currentView !== 'login') {
                renderDashboard();
              }
            }
          })
          .catch(err => console.warn('Background sync failed:', err));
          
      } catch (e) {
        localStorage.removeItem('smartlab_local_data');
        startFreshSync();
      }
    } else {
      startFreshSync();
    }
  }

  function startFreshSync() {
    appElement.innerHTML = `<div class="login-container"><div class="login-box" style="text-align: center;"><h2>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå...</h2></div></div>`;
    callApi('sync').then(onSyncSuccess).catch(onFailure);
  }

  function onSyncSuccess(response) {
    if (response.success && response.data) {
      allData = response.data;
      console.log('Data Synced:', allData.length);
      localStorage.setItem('smartlab_local_data', JSON.stringify(allData));
      initializeDefaultAdmin();
    } else {
      onFailure(new Error('Failed to sync data or no data returned.'));
    }
  }
  
  // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£ ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö
  function onCrudSuccess(response) {
    if (!response.success) {
      const specificError = response.message || 'CRUD operation failed';
      showErrorMessage(specificError); 
      onFailure(new Error(specificError));
      return;
    }
    
    console.log('‚úÖ CRUD Success:', response.action);
    
    if (response.action === 'create') {
      allData.push(response.data);
    } 
    else if (response.action === 'update') {
      // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏±‡πâ‡∏á backendId ‡πÅ‡∏•‡∏∞ id)
      const index = allData.findIndex(i => 
        (i.__backendId && response.data.__backendId && i.__backendId === response.data.__backendId) || 
        (i.id && response.data.id && i.id === response.data.id)
      );

      if (index > -1) {
        allData[index] = response.data;
        if (currentUser && (
            (currentUser.__backendId && currentUser.__backendId === response.data.__backendId) ||
            (currentUser.id && currentUser.id === response.data.id)
        )) {
          const displayName = (`${response.data.firstName || ''} ${response.data.lastName || ''}`).trim();
          currentUser.displayName = displayName || response.data.username;
        }
      } else {
        allData.push(response.data);
      }
    } 
    else if (response.action === 'delete') {
      allData = allData.filter(i => {
         const matchBackend = i.__backendId && response.id && i.__backendId === response.id;
         const matchId = i.id && response.id && i.id === response.id;
         return !(matchBackend || matchId);
      });
    }
    
    localStorage.setItem('smartlab_local_data', JSON.stringify(allData));
    closeModal();
    renderDashboard(); 
  }

  // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°
  function onBorrowSuccess(response) {
      if (!response.success) {
        return onFailure(new Error(response.message || 'Borrow operation failed'));
      }
      
      console.log('Borrow Success:', response.action);
      
      allData.push(response.borrow);
      
      const index = allData.findIndex(i => i.__backendId === response.item.__backendId);
      if (index > -1) {
        allData[index] = response.item;
      } else {
        allData.push(response.item);
      }

      localStorage.setItem('smartlab_local_data', JSON.stringify(allData));
      closeModal();
      currentTab = 'borrow';
      renderDashboard();
    }

  function onFailure(error) {
    console.error('API Error:', error);
    const errorBox = loginErrorElement || document.querySelector('.error-toast');
    if (errorBox && !document.querySelector('.error-toast')) {
         showErrorMessage(error.message);
    }
    const modalSubmitBtn = document.querySelector('.modal-content button[type="submit"]');
    if (modalSubmitBtn) {
        modalSubmitBtn.disabled = false;
        modalSubmitBtn.textContent = modalSubmitBtn.dataset.originalText || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
    }
    if(loginButtonElement) {
        loginButtonElement.disabled = false;
        loginButtonElement.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
    }
  }

  // --- CRUD Functions ---

  function createItem(data) {
    console.log('Creating item...', data);
    callApi('create', data).then(onCrudSuccess).catch(onFailure);
  }

  function updateItem(data) {
    console.log('Updating item...', data);
    callApi('update', data).then(onCrudSuccess).catch(onFailure);
  }
  
  function deleteItem(backendId) {
    const item = allData.find(i => i.__backendId === backendId);
    if (!item) return;

    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <div style="text-align: center; padding: 20px 0;">
          <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
          <p style="margin-bottom: 24px; color: #6b7280; font-size: 16px;">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "<strong>${item.name || item.username}</strong>" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?<br><small>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ</small></p>
        </div>
        <div style="display: flex; gap: 12px; justify-content: center;">
          <button class="btn btn-secondary" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDelete('${backendId}')">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
      </div>
    `;
    modalElement.classList.add('active');
  }

  function confirmDelete(backendId) {
    const btn = document.getElementById('confirmDeleteBtn');
    if(btn) {
        btn.disabled = true;
        btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...';
    }
    callApi('delete', { id: backendId }).then(onCrudSuccess).catch(onFailure);
  }
  
  // --- Original Functions ---

  async function initializeDefaultAdmin() {
    const adminExists = allData.find(item => item.type === 'user' && item.username === 'admin');
    if (!adminExists) {
      const adminData = {
        id: 'admin-' + Date.now(), type: 'user', username: 'admin', password: 'admin123', role: 'admin', createdAt: new Date().toISOString()
      };
      callApi('create', adminData).then(onAdminCreated).catch(onFailure);
    } else {
      renderLogin();
    }
  }
  
  function onAdminCreated(response) {
    if (!response.success) { return onFailure(new Error('Failed to create admin user.')); }
    callApi('sync').then((syncResponse) => {
        if (syncResponse.success && syncResponse.data) {
          allData = syncResponse.data;
          renderLogin();
        } else { onFailure(new Error('Failed to sync after admin creation.')); }
    }).catch(onFailure);
  }

  function renderLogin() {
    currentView = 'login';
    const title = defaultConfig.system_title;
    const logoUrl = defaultConfig.logo_url;
    const welcomeMsg = defaultConfig.welcome_message;

    appElement.innerHTML = `
      <div class="login-container">
        <div class="login-box">
          <div class="logo-container">
            <div class="logo">${logoUrl ? `<img src="${logoUrl}" alt="Logo">` : 'üß™'}</div>
            <h1 class="system-title">${title}</h1>
            <p class="subtitle">${welcomeMsg}</p>
          </div>
          <div id="loginError"></div>
          <form id="loginForm">
            <div class="form-group"><label for="username">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label><input type="text" id="username" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"></div>
            <div class="form-group"><label for="password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><div class="input-wrapper"><input type="password" id="password" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"><span class="eye-icon" onclick="togglePassword()">${SVG_EYE_SHOW}</span></div></div>
            <button type="submit" id="loginButton" class="btn btn-primary">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
          </form>
          <div class="info-box" style="margin-top: 20px;"><p style="text-align: center; white-space: nowrap; font-size: 13px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ | ‡∏Ñ‡∏£‡∏π‡∏≠‡∏≤‡∏ô‡∏ô‡∏ó‡πå ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ß</p></div>
        </div>
      </div>
    `;

    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    loginButtonElement = document.getElementById('loginButton');
    loginErrorElement = document.getElementById('loginError');
  }

  function togglePassword() {
    const passwordInput = document.getElementById('password');
    const eyeIcon = document.querySelector('#loginForm .eye-icon'); 
    if (!passwordInput || !eyeIcon) return;
    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      eyeIcon.innerHTML = SVG_EYE_HIDE;
    } else {
      passwordInput.type = 'password';
      eyeIcon.innerHTML = SVG_EYE_SHOW;
    }
  }

  async function handleLogin(e) {
    e.preventDefault();
    if(loginButtonElement) {
      loginButtonElement.disabled = true;
      loginButtonElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
    }
    if(loginErrorElement) loginErrorElement.innerHTML = '';
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    callApi('login', { username: username, password: password }).then(onLoginSuccess).catch(onFailure);
  }
  
  // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡πá‡∏≠‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏õ‡∏∏‡πä‡∏ö ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏õ‡∏±‡πä‡∏ö + ‡∏°‡∏µ‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏û‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö
  function onLoginSuccess(response) {
    if(loginButtonElement) {
      loginButtonElement.disabled = false;
      loginButtonElement.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
    }

    if (response.success && response.user) {
      currentUser = response.user;
      const displayName = (`${currentUser.firstName || ''} ${currentUser.lastName || ''}`).trim();
      currentUser.displayName = displayName || currentUser.username; 
      currentView = currentUser.role === 'admin' ? 'admin' : 'teacher';
      currentTab = 'dashboard';
      
      // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏û‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      showWelcomeToast(currentUser.displayName, currentUser.role);

      // ‡πÄ‡∏Ç‡πâ‡∏≤ Dashboard ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      if (allData && allData.length > 0) {
        renderDashboard();
      } else {
        appElement.innerHTML = `<div class="login-container"><div class="login-box" style="text-align: center;"><h2>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h2></div></div>`;
        callApi('sync').then(res => {
             if(res.success && res.data) {
                 allData = res.data;
                 localStorage.setItem('smartlab_local_data', JSON.stringify(allData));
                 renderDashboard();
             }
        }).catch(onFailure);
      }

    } else {
      if(loginErrorElement) {
        loginErrorElement.innerHTML = '<div class="error-message">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>';
      }
    }
  }

  function renderDashboard() {
    if (!appElement) appElement = document.getElementById('app');
    const title = defaultConfig.system_title;
    const logoUrl = defaultConfig.logo_url;
    if (currentUser.role === 'admin') {
      renderAdminDashboard(title, logoUrl);
    } else {
      renderTeacherDashboard(title, logoUrl);
    }
    modalElement = document.getElementById('modal');
  }

  function renderAdminDashboard(title, logoUrl) {
    const chemicals = allData.filter(item => item.type === 'chemical');
    const equipment = allData.filter(item => item.type === 'equipment');
    const users = allData.filter(item => item.type === 'user' && item.role === 'teacher');
    const lowStockChemicals = chemicals.filter(item => item.quantity <= (item.minStock || 0));
    const lowStockEquipment = equipment.filter(item => item.quantity <= (item.minStock || 0));
    const totalLowStock = lowStockChemicals.length + lowStockEquipment.length; 

    appElement.innerHTML = `
      <div class="container">
        <div class="header">
          <div class="header-left">
            <div class="header-logo">${logoUrl ? `<img src="${logoUrl}" alt="Logo">` : 'üß™'}</div>
            <div class="header-info"><h2 class="system-title">${title}</h2><p>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö: ${currentUser.displayName}</p></div>
          </div>
          <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° btn-logout ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
          <div class="header-right"><button class="btn btn-secondary btn-small btn-logout" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button></div>
        </div>
        <div class="nav-tabs">
          <button class="nav-tab ${currentTab === 'dashboard' ? 'active' : ''}" onclick="switchTab('dashboard')">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
          <button class="nav-tab ${currentTab === 'chemicals' ? 'active' : ''}" onclick="switchTab('chemicals')">üß¨ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</button>
          <button class="nav-tab ${currentTab === 'equipment' ? 'active' : ''}" onclick="switchTab('equipment')">üî¨ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
          <button class="nav-tab ${currentTab === 'users' ? 'active' : ''}" onclick="switchTab('users')">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
          <button class="nav-tab ${currentTab === 'reports' ? 'active' : ''}" onclick="switchTab('reports')">üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
        </div>
        
        <div id="dashboardSection" class="content-section ${currentTab === 'dashboard' ? 'active' : ''}">
          <div class="stats-grid">
            <div class="stat-card"><h3>‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><p class="number">${chemicals.length}</p></div>
            <div class="stat-card"><h3>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><p class="number">${equipment.length}</p></div>
            <div class="stat-card"><h3>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3><p class="number">${users.length}</p></div>
            <div class="stat-card"><h3>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥</h3><p class="number" style="color: #dc2626;">${totalLowStock}</p></div>
          </div>
          ${lowStockChemicals.length > 0 ? `
            <div class="card"><div class="academic-header"><h3>üß¨ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥ (‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ)</h3></div><div class="table-container"><table><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</th><th>‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö</th></tr></thead><tbody>${lowStockChemicals.map(item => `<tr><td><strong>${item.name}</strong></td><td>${item.formula || '-'}</td><td><span class="badge badge-low">${item.quantity} ${item.unit}</span></td><td>${item.minStock || 0} ${item.unit}</td><td>${item.location}</td></tr>`).join('')}</tbody></table></div></div>
          ` : ''}
          ${lowStockEquipment.length > 0 ? `
            <div class="card"><div class="academic-header"><h3>üî¨ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥ (‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå)</h3></div><div class="table-container"><table><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö</th></tr></thead><tbody>${lowStockEquipment.map(item => `<tr><td><strong>${item.name}</strong></td><td><span class="badge badge-low">${item.quantity} ${item.unit}</span></td><td>${item.minStock || 0} ${item.unit}</td><td>${item.location}</td></tr>`).join('')}</tbody></table></div></div>
          ` : ''}
          ${totalLowStock === 0 ? `<div class="card"><div class="empty-state" style="padding: 40px 20px;"><div class="empty-state-icon" style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div><span style="color: #6b7280;">‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°!</span><br>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥</div></div>` : ''}
        </div>
        <div id="chemicalsSection" class="content-section ${currentTab === 'chemicals' ? 'active' : ''}">${renderChemicalsSection()}</div>
        <div id="equipmentSection" class="content-section ${currentTab === 'equipment' ? 'active' : ''}">${renderEquipmentSection()}</div>
        <div id="usersSection" class="content-section ${currentTab === 'users' ? 'active' : ''}">${renderUsersSection()}</div>
        <div id="reportsSection" class="content-section ${currentTab === 'reports' ? 'active' : ''}">${renderReportsSection()}</div>
        <div class="page-footer">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏≠‡∏≤‡∏ô‡∏ô‡∏ó‡πå ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ß</div>
      </div>
      <div id="modal" class="modal"></div>
    `;
    modalElement = document.getElementById('modal');
  }

  function renderChemicalsSection() {
    const chemicals = allData.filter(item => item.type === 'chemical');
    return `
      <div class="card">
        <div class="academic-header"><h3>üß¨ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</h3></div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
          <div class="info-box" style="flex: 1; margin: 0;"><p>üìã ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${chemicals.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div>
          <button class="btn btn-primary btn-small" onclick="openAddChemicalModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</button>
        </div>
        <div class="search-box"><input type="text" id="chemicalSearch" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ (‡∏ä‡∏∑‡πà‡∏≠, ‡∏™‡∏π‡∏ï‡∏£, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö)..." onkeyup="filterChemicals()"></div>
        <div class="table-container academic-table">
          <table id="chemicalsTable">
            <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</th><th>‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö</th><th>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
            <tbody>
              ${chemicals.length > 0 ? chemicals.map(item => `
                <tr>
                  <td><strong>${item.name}</strong></td>
                  <td>${item.formula || '-'}</td>
                  <td><span class="badge ${item.quantity <= (item.minStock || 0) ? 'badge-low' : 'badge-normal'}">${item.quantity}</span></td>
                  <td>${item.unit}</td>
                  <td>${item.location}</td>
                  <td>${item.minStock || 0}</td>
                  <td>
                    <button class="btn btn-secondary btn-small" onclick='editChemical(${JSON.stringify(item)})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="btn btn-danger btn-small" onclick='deleteItem("${item.__backendId}")'>‡∏•‡∏ö</button>
                  </td>
                </tr>
              `).join('') : '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üìã</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ<br><small>‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</small></td></tr>'}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }

  function renderEquipmentSection() {
    const equipment = allData.filter(item => item.type === 'equipment');
    return `
      <div class="card">
        <div class="academic-header"><h3>üî¨ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3></div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
          <div class="info-box" style="flex: 1; margin: 0;"><p>üìã ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${equipment.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div>
          <button class="btn btn-primary btn-small" onclick="openAddEquipmentModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
        </div>
        <div class="search-box"><input type="text" id="equipmentSearch" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (‡∏ä‡∏∑‡πà‡∏≠, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö)..." onkeyup="filterEquipment()"></div>
        <div class="table-container academic-table">
          <table id="equipmentTable">
            <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö</th><th>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
            <tbody>
              ${equipment.length > 0 ? equipment.map(item => `
                <tr>
                  <td><strong>${item.name}</strong></td>
                  <td><span class="badge ${item.quantity <= (item.minStock || 0) ? 'badge-low' : 'badge-normal'}">${item.quantity}</span></td>
                  <td>${item.unit}</td>
                  <td>${item.location}</td>
                  <td>${item.minStock || 0}</td>
                  <td>
                    <button class="btn btn-secondary btn-small" onclick='editEquipment(${JSON.stringify(item)})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="btn btn-danger btn-small" onclick='deleteItem("${item.__backendId}")'>‡∏•‡∏ö</button>
                  </td>
                </tr>
              `).join('') : '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üî¨</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå<br><small>‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</small></td></tr>'}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }

  function renderUsersSection() {
  const users = allData.filter(item => item.type === 'user' && item.role === 'teacher');
  return `
    <div class="card">
      <div class="academic-header"><h3>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3></div>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
        <div class="info-box" style="flex: 1; margin: 0;"><p>üë®‚Äçüè´ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ${users.length} ‡∏Ñ‡∏ô</p></div>
        <div style="display: flex; gap: 8px; flex-shrink: 0;">
          <button class="btn btn-primary btn-small" onclick="openAddUserModal()" style="display: flex; align-items: center; justify-content: center; padding: 6px 12px; font-weight: 500; line-height: 1.4; border-radius: 6px;">+&nbsp;‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
          <button class="btn btn-danger btn-small" onclick="downloadUserReport()" style="display: flex; align-items: center; justify-content: center; padding: 6px 12px; min-width: 70px; font-weight: 500; line-height: 1.4; border-radius: 6px;">üìÑ&nbsp;PDF</button>
        </div>
      </div>
      <div class="table-container academic-table">
        <table>
          <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th><th>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
          <tbody>
            ${users.length > 0 ? users.map((item) => `
              <tr>
                <td><strong>${(item.firstName || '') + ' ' + (item.lastName || '')}</strong></td>
                <td>${item.username}</td>
                <td>‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</td>
                <td><span class="badge badge-normal">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</span></td>
                <td>
                  <button class="btn btn-secondary btn-small" onclick='editUser(${JSON.stringify(item)})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                  <button class="btn btn-danger btn-small" onclick='deleteItem("${item.__backendId}")'>‡∏•‡∏ö</button>
                </td>
              </tr>`).join('') : '<tr><td colspan="5" class="empty-state"><div class="empty-state-icon">üë•</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ<br><small>‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</small></td></tr>'}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

  function renderReportsSection() {
    const allBorrows = allData.filter(item => item.type === 'borrow');
    const chemicals = allData.filter(item => item.type === 'chemical');
    const equipment = allData.filter(item => item.type === 'equipment');
    const users = allData.filter(item => item.type === 'user');
    const allIssueReports = allData.filter(item => item.type === 'issue_report');

    const validUsernames = new Set(users.map(u => u.username));
    const validItemIds = new Set([...chemicals.map(c => c.__backendId), ...equipment.map(e => e.__backendId)]);

    const validBorrows = allBorrows.filter(borrow => {
        const userExists = validUsernames.has(borrow.borrower);
        const itemExists = validItemIds.has(borrow.itemId);
        return userExists && itemExists; 
    });
    
    const validIssueReports = allIssueReports.filter(report => {
        const userExists = validUsernames.has(report.reportedBy); 
        const itemExists = validItemIds.has(report.itemId);
        return userExists && itemExists;
    });
    
    const issueReportsChemical = validIssueReports.filter(item => item.issueType === 'out_of_stock');
    const issueReportsEquipment = validIssueReports.filter(item => item.issueType === 'damaged');

    const borrowsByUser = validBorrows.reduce((acc, borrow) => {
      const user = borrow.borrower;
      if (!acc[user]) acc[user] = [];
      acc[user].push(borrow);
      return acc;
    }, {});
    
    const sortedUsers = Object.keys(borrowsByUser).sort();
    
    return `
      <div class="card">
        <div class="academic-header"><h3>üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô (‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏£‡∏π)</h3></div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
          <div class="search-box" style="flex: 1; margin: 0;"><input type="text" id="reportSearch" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π, ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°)..." onkeyup="filterReports()"></div>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-success btn-small" onclick="downloadBorrowReport('excel')">üìä Excel (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</button>
            <button class="btn btn-danger btn-small" onclick="downloadBorrowReport('pdf')">üìÑ PDF (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</button>
          </div>
        </div>
        <div id="reportAccordionContainer">
          ${sortedUsers.length > 0 ? sortedUsers.map(user => {
            const userBorrows = borrowsByUser[user];
            const pendingCount = userBorrows.filter(b => b.status === 'pending').length;
            const safeId = 'report-user-' + user.replace(/[^a-zA-Z0-9]/g, ''); 
            return `
              <div class="report-group-card" data-searchable-text="${user.toLowerCase()} ${userBorrows.map(b => b.itemName).join(' ').toLowerCase()}">
                <div class="report-group-header" onclick="toggleBorrowDetail('${safeId}')">
                  <h4><span style="font-size: 20px;">üë®‚Äçüè´</span> ${user}</h4>
                  <div class="stats"><span>‡∏£‡∏ß‡∏°: ${userBorrows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span> | <span style="color: ${pendingCount > 0 ? '#d97706' : '#059669'}; font-weight: 600;">‡∏Ñ‡πâ‡∏≤‡∏á: ${pendingCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></div>
                  <div class="toggle-icon">‚ñ∏</div>
                </div>
                <div class="report-group-details" id="${safeId}" style="display: none;">
                  <div class="table-container academic-table">
                    <table>
                      <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
                      <tbody>
                        ${userBorrows.map(item => `
                          <tr>
                            <td><strong>${item.itemName}</strong></td>
                            <td>${item.itemType === 'chemical' ? '‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ' : '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå'}</td>
                            <td>${item.amount}</td>
                            <td>${item.room}</td>
                            <td>${new Date(item.borrowDate).toLocaleDateString('th-TH')}</td>
                            <td>${item.returnDate ? new Date(item.returnDate).toLocaleDateString('th-TH') : '-'}</td>
                            <td><span class="badge ${item.status === 'returned' ? 'badge-returned' : 'badge-pending'}">${item.status === 'returned' ? '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô'}</span></td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            `;
          }).join('') : '<div class="empty-state"><div class="empty-state-icon">üìà</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô</div>'}
        </div>
      </div>
      <div class="card"><div class="academic-header"><h3>üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3></div>${renderInventoryReportStats(chemicals, equipment)}</div>
      <div class="card"><div class="academic-header"><h3>üß¨ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î</h3></div>${renderIssueReportTable(issueReportsChemical, '‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß', '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', '‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß')}</div>
      <div class="card"><div class="academic-header"><h3>üî¨ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∏‡∏î</h3></div>${renderIssueReportTable(issueReportsEquipment, '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', '‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß', '‡∏£‡∏≠‡∏ã‡πà‡∏≠‡∏°', '‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à', '‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î')}</div>
    `;
  }

  function renderInventoryReportStats(chemicals, equipment) {
    return `
      <div class="stats-grid" style="margin-bottom: 20px;">
        <div class="stat-card"><h3>‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><p class="number">${chemicals.length}</p></div>
        <div class="stat-card"><h3>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><p class="number">${equipment.length}</p></div>
        <div class="stat-card"><h3>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥</h3><p class="number" style="color: #d97706;">${[...chemicals, ...equipment].filter(item => item.quantity <= (item.minStock || 0)).length}</p></div>
      </div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 20px;">
        <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid #bfdbfe; padding: 16px; border-radius: 12px;">
          <h4 style="margin: 0 0 12px 0; color: #1f2937; font-size: 16px;">üìä ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</h4>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 14px; font-weight: 500;">üß¨ ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ:</span><div><button class="btn btn-success btn-small" style="margin-left: 5px;" onclick="downloadInventoryReport('all_chemicals', 'excel')">üìä Excel</button><button class="btn btn-danger btn-small" style="margin-left: 5px;" onclick="downloadInventoryReport('all_chemicals', 'pdf')">üìÑ PDF</button></div></div>
            <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #cce7fe; padding-top: 10px;"><span style="font-size: 14px; font-weight: 500;">üî¨ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</span><div><button class="btn btn-success btn-small" style="margin-left: 5px;" onclick="downloadInventoryReport('all_equipment', 'excel')">üìä Excel</button><button class="btn btn-danger btn-small" style="margin-left: 5px;" onclick="downloadInventoryReport('all_equipment', 'pdf')">üìÑ PDF</button></div></div>
          </div>
        </div>
        <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid #bbf7d0; padding: 16px; border-radius: 12px;">
          <h4 style="margin: 0 0 12px 0; color: #1f2937; font-size: 16px;">‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠)</h4>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 14px; font-weight: 500;">üß¨ ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ:</span><div><button class="btn btn-success btn-small" style="margin-left: 5px;" onclick="downloadInventoryReport('available_chemicals', 'excel')">üìä Excel</button><button class="btn btn-danger btn-small" style="margin-left: 5px;" onclick="downloadInventoryReport('available_chemicals', 'pdf')">üìÑ PDF</button></div></div>
            <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #d1f7e1; padding-top: 10px;"><span style="font-size: 14px; font-weight: 500;">üî¨ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</span><div><button class="btn btn-success btn-small" style="margin-left: 5px;" onclick="downloadInventoryReport('available_equipment', 'excel')">üìä Excel</button><button class="btn btn-danger btn-small" style="margin-left: 5px;" onclick="downloadInventoryReport('available_equipment', 'pdf')">üìÑ PDF</button></div></div>
          </div>
        </div>
        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #f59e0b; padding: 16px; border-radius: 12px;">
          <h4 style="margin: 0 0 12px 0; color: #1f2937; font-size: 16px;">‚ö†Ô∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î (‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°)</h4>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 14px; font-weight: 500;">üß¨ ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ:</span><div><button class="btn btn-success btn-small" style="margin-left: 5px;" onclick="downloadInventoryReport('reorder_chemicals', 'excel')">üìä Excel</button><button class="btn btn-danger btn-small" style="margin-left: 5px;" onclick="downloadInventoryReport('reorder_chemicals', 'pdf')">üìÑ PDF</button></div></div>
            <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f6e0b7; padding-top: 10px;"><span style="font-size: 14px; font-weight: 500;">üî¨ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</span><div><button class="btn btn-success btn-small" style="margin-left: 5px;" onclick="downloadInventoryReport('reorder_equipment', 'excel')">üìä Excel</button><button class="btn btn-danger btn-small" style="margin-left: 5px;" onclick="downloadInventoryReport('reorder_equipment', 'pdf')">üìÑ PDF</button></div></div>
          </div>
        </div>
      </div>
    `;
  }
  
  function renderIssueReportTable(reports, itemLabel, resolvedText, pendingText, primaryActionText, secondaryActionText) {
    const isChemical = itemLabel === '‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ';
    const amountLabel = isChemical ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á' : '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏≥‡∏£‡∏∏‡∏î';
    return `
      <div style="margin-bottom: 20px;"><div class="info-box"><p>‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô${itemLabel}‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏π: ${reports.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div></div>
      <div class="table-container academic-table">
        <table>
          <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠${itemLabel}</th><th>‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</th><th>${amountLabel}</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
          <tbody>
            ${reports.length > 0 ? reports.map(report => {
              const item = allData.find(i => i.__backendId === report.itemId);
              const amount = isChemical ? report.originalAmount : report.damagedAmount;
              const primaryAction = isChemical 
                ? `onclick='resolveChemicalIssue(${JSON.stringify(report)}, ${JSON.stringify(item)})'`
                : `onclick='resolveEquipmentIssue(${JSON.stringify(report)}, ${JSON.stringify(item)})'`;
              const secondaryAction = isChemical
                ? `onclick='markIssueResolved(${JSON.stringify(report)})'`
                : `onclick='viewEquipmentDetails("${report.itemId}")'`;
              return `
                <tr>
                  <td><strong>${report.itemName}</strong></td>
                  <td>${report.reportedBy}</td>
                  <td>${new Date(report.reportDate).toLocaleDateString('th-TH')}</td>
                  <td><span class="badge ${isChemical ? 'badge-pending' : 'badge-low'}">${amount}</span></td>
                  <td>${report.note || '-'}</td>
                  <td><span class="badge ${report.status === 'resolved' ? 'badge-returned' : 'badge-pending'}">${report.status === 'resolved' ? resolvedText : pendingText}</span></td>
                  <td>
                    ${report.status !== 'resolved' ? `
                      <button class="btn btn-success btn-small" ${primaryAction}>${primaryActionText}</button>
                      <button class="btn btn-secondary btn-small" ${secondaryAction}>${secondaryActionText}</button>
                    ` : '<span style="color: #9ca3af;">-</span>'}
                  </td>
                </tr>
              `}).join('') : `<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">‚úÖ</div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô${itemLabel}</td></tr>`
            }
          </tbody>
        </table>
      </div>
    `;
  }

  function renderTeacherDashboard(title, logoUrl) {
    const chemicals = allData.filter(item => item.type === 'chemical');
    const equipment = allData.filter(item => item.type === 'equipment');
    const myBorrows = allData.filter(item => item.type === 'borrow' && item.borrower === currentUser.username);
    const pendingBorrows = myBorrows.filter(item => item.status === 'pending');
    const myChemicalBorrows = myBorrows.filter(item => item.itemType === 'chemical');
    const myEquipmentBorrows = myBorrows.filter(item => item.itemType === 'equipment');

    appElement.innerHTML = `
      <div class="container">
        <div class="header">
          <div class="header-left">
            <div class="header-logo">${logoUrl ? `<img src="${logoUrl}" alt="Logo">` : 'üß™'}</div>
            <div class="header-info"><h2 class="system-title">${title}</h2><p>‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ${currentUser.displayName}</p></div>
          </div>
          <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° btn-logout ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
          <div class="header-right"><button class="btn btn-secondary btn-small btn-logout" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button></div>
        </div>
        <div class="nav-tabs">
          <button class="nav-tab ${currentTab === 'dashboard' ? 'active' : ''}" onclick="switchTab('dashboard')">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
          <button class="nav-tab ${currentTab === 'borrow' ? 'active' : ''}" onclick="switchTab('borrow')">üìù ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</button>
          <button class="nav-tab ${currentTab === 'history' ? 'active' : ''}" onclick="switchTab('history')">üìñ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
        </div>
        <div id="dashboardSection" class="content-section ${currentTab === 'dashboard' ? 'active' : ''}">
          <div class="stats-grid">
            <div class="stat-card"><h3>‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ</h3><p class="number">${chemicals.length}</p></div>
            <div class="stat-card"><h3>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ</h3><p class="number">${equipment.length}</p></div>
            <div class="stat-card"><h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</h3><p class="number">${myBorrows.length}</p></div>
            <div class="stat-card"><h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô</h3><p class="number" style="color: #d97706;">${pendingBorrows.length}</p></div>
          </div>
          <div class="card">
            <div class="academic-header"><h3>üß¨ ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3></div>
            <div class="search-box"><input type="text" id="chemicalSearchTeacher" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ..." onkeyup="filterTeacherChemicals()"></div>
            <div class="table-container academic-table">
              <table id="teacherChemicalsTable">
                <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</th><th>‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö</th><th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody>
                  ${chemicals.length > 0 ? chemicals.map(item => `
                    <tr>
                      <td><strong>${item.name}</strong></td>
                      <td>${item.formula || '-'}</td>
                      <td><span class="badge ${item.quantity <= (item.minStock || 0) ? 'badge-low' : 'badge-normal'}">${item.quantity} ${item.unit}</span></td>
                      <td>${item.location}</td>
                      <td>${item.quantity > 0 ? `<button class="btn btn-primary btn-small" onclick='quickBorrowChemical(${JSON.stringify(item)})'>‡∏¢‡∏∑‡∏°</button>` : `<button class="btn btn-danger btn-small" onclick='reportOutOfStock(${JSON.stringify(item)})'>‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏´‡∏°‡∏î</button>`}</td>
                    </tr>
                  `).join('') : '<tr><td colspan="5" class="empty-state">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>
          <div class="card">
            <div class="academic-header"><h3>üî¨ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3></div>
            <div class="search-box"><input type="text" id="equipmentSearchTeacher" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå..." onkeyup="filterTeacherEquipment()"></div>
            <div class="table-container academic-table">
              <table id="teacherEquipmentTable">
                <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö</th><th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody>
                  ${equipment.length > 0 ? equipment.map(item => `
                    <tr>
                      <td><strong>${item.name}</strong></td>
                      <td><span class="badge ${item.quantity <= (item.minStock || 0) ? 'badge-low' : 'badge-normal'}">${item.quantity} ${item.unit}</span></td>
                      <td>${item.location}</td>
                      <td>${item.quantity > 0 ? `<button class="btn btn-primary btn-small" onclick='quickBorrowEquipment(${JSON.stringify(item)})'>‡∏¢‡∏∑‡∏°</button>` : `<button class="btn btn-danger btn-small" onclick='reportDamaged(${JSON.stringify(item)})'>‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏≥‡∏£‡∏∏‡∏î</button>`}</td>
                    </tr>
                  `).join('') : '<tr><td colspan="4" class="empty-state">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div id="borrowSection" class="content-section ${currentTab === 'borrow' ? 'active' : ''}">
          <div class="card">
            <div class="academic-header"><h3>üß¨ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</h3></div>
            <div class="table-container academic-table">
              <table>
                <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody>
                  ${myChemicalBorrows.length > 0 ? myChemicalBorrows.map(item => `
                    <tr>
                      <td><strong>${item.itemName}</strong>${item.issueReported ? '<br><small style="color: #d97706;">‚ö†Ô∏è ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</small>' : ''}</td>
                      <td>${item.amount}${item.issueReported ? `<br><small style="color: #6b7280;">‡πÄ‡∏î‡∏¥‡∏°: ${(parseFloat(item.amount) + parseFloat(item.issueAmount)).toFixed(2)}</small>` : ''}</td>
                      <td>${item.room}</td>
                      <td>${new Date(item.borrowDate).toLocaleDateString('th-TH')}</td>
                      <td>${item.returnDate ? new Date(item.returnDate).toLocaleDateString('th-TH') : '-'}</td>
                      <td><span class="badge ${item.status === 'returned' ? 'badge-returned' : 'badge-pending'}">${item.status === 'returned' ? '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô'}</span></td>
                      <td>${item.status === 'pending' ? `<button class="btn btn-secondary btn-small" onclick='editBorrow(${JSON.stringify(item)})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button class="btn btn-success btn-small" onclick='returnItem(${JSON.stringify(item)})'>‡∏Ñ‡∏∑‡∏ô</button>${!item.issueReported ? `<button class="btn btn-danger btn-small" onclick='reportIssueFromBorrow(${JSON.stringify(item)})'>‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</button>` : ''}` : '<span style="color: #9ca3af;">-</span>'}</td>
                    </tr>
                  `).join('') : '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üìù</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>
          <div class="card">
            <div class="academic-header"><h3>üî¨ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3></div>
            <div class="table-container academic-table">
              <table>
                <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody>
                  ${myEquipmentBorrows.length > 0 ? myEquipmentBorrows.map(item => `
                    <tr>
                      <td><strong>${item.itemName}</strong>${item.issueReported ? '<br><small style="color: #d97706;">‚ö†Ô∏è ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</small>' : ''}</td>
                      <td>${item.amount}${item.issueReported ? `<br><small style="color: #6b7280;">‡πÄ‡∏î‡∏¥‡∏°: ${(parseFloat(item.amount) + parseFloat(item.issueAmount)).toFixed(0)}</small>` : ''}</td>
                      <td>${item.room}</td>
                      <td>${new Date(item.borrowDate).toLocaleDateString('th-TH')}</td>
                      <td>${item.returnDate ? new Date(item.returnDate).toLocaleDateString('th-TH') : '-'}</td>
                      <td><span class="badge ${item.status === 'returned' ? 'badge-returned' : 'badge-pending'}">${item.status === 'returned' ? '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô'}</span></td>
                      <td>${item.status === 'pending' ? `<button class="btn btn-secondary btn-small" onclick='editBorrow(${JSON.stringify(item)})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button class="btn btn-success btn-small" onclick='returnItem(${JSON.stringify(item)})'>‡∏Ñ‡∏∑‡∏ô</button>${!item.issueReported ? `<button class="btn btn-danger btn-small" onclick='reportIssueFromBorrow(${JSON.stringify(item)})'>‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</button>` : ''}` : '<span style="color: #9ca3af;">-</span>'}</td>
                    </tr>
                  `).join('') : '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üìù</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div id="historySection" class="content-section ${currentTab === 'history' ? 'active' : ''}">
          <div class="card">
            <div class="academic-header"><h3>üìñ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</h3></div>
            <div class="table-container academic-table">
              <table>
                <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
                <tbody>
                  ${myChemicalBorrows.length > 0 ? myChemicalBorrows.map(item => `<tr><td><strong>${item.itemName}</strong></td><td>${item.amount}</td><td>${item.room}</td><td>${new Date(item.borrowDate).toLocaleDateString('th-TH')}</td><td>${item.returnDate ? new Date(item.returnDate).toLocaleDateString('th-TH') : '-'}</td><td><span class="badge ${item.status === 'returned' ? 'badge-returned' : 'badge-pending'}">${item.status === 'returned' ? '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô'}</span></td></tr>`).join('') : '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üìñ</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>
          <div class="card">
            <div class="academic-header"><h3>üìñ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3></div>
            <div class="table-container academic-table">
              <table>
                <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏´‡πâ‡∏≠‡∏á</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
                <tbody>
                  ${myEquipmentBorrows.length > 0 ? myEquipmentBorrows.map(item => `<tr><td><strong>${item.itemName}</strong></td><td>${item.amount}</td><td>${item.room}</td><td>${new Date(item.borrowDate).toLocaleDateString('th-TH')}</td><td>${item.returnDate ? new Date(item.returnDate).toLocaleDateString('th-TH') : '-'}</td><td><span class="badge ${item.status === 'returned' ? 'badge-returned' : 'badge-pending'}">${item.status === 'returned' ? '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô'}</span></td></tr>`).join('') : '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üìñ</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="page-footer">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏≠‡∏≤‡∏ô‡∏ô‡∏ó‡πå ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ß</div>
      </div>
      <div id="modal" class="modal"></div>
    `;
    modalElement = document.getElementById('modal');
  }

  function switchTab(tab) {
    currentTab = tab;
    renderDashboard();
  }

  function logout() {
    currentUser = null;
    currentView = 'login';
    currentTab = 'dashboard';
    // ‡πÑ‡∏°‡πà‡∏•‡∏ö allData ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Login ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    renderLogin();
  }
  
  function closeModal() {
    if(!modalElement) modalElement = document.getElementById('modal');
    if(modalElement) {
        modalElement.classList.remove('active');
        setTimeout(() => {
             if (!modalElement.classList.contains('active')) {
                 modalElement.innerHTML = '';
             }
        }, 300);
    }
  }
  
  function toggleBorrowDetail(elementId) {
    const detailElement = document.getElementById(elementId);
    const headerElement = document.querySelector(`[onclick="toggleBorrowDetail('${elementId}')"]`);
    if (detailElement) {
      if (detailElement.style.display === 'none' || detailElement.style.display === '') {
        detailElement.style.display = 'block';
        if (headerElement) headerElement.classList.add('open');
      } else {
        detailElement.style.display = 'none';
        if (headerElement) headerElement.classList.remove('open');
      }
    }
  }

  window.onclick = function(event) {
    if (event.target === modalElement) {
      closeModal();
    }
  };

  function downloadUserReport() {
    const users = allData.filter(item => item.type === 'user' && item.role === 'teacher');
    if (users.length === 0) {
        showErrorMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
        return;
    }
    const title = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏£‡∏π)';
    const filename = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}`;
    const reportData = users.map(user => ({ '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•': (`${user.firstName || ''} ${user.lastName || ''}`).trim() || '-', '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ': user.username, '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô': user.password }));
    const headers = ['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'];
    downloadPDF(reportData, title, filename, headers);
  }

  function openAddChemicalModal() {
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡πÉ‡∏´‡∏°‡πà</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="addChemicalForm">
          <div class="form-group"><label for="chemName">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ *</label><input type="text" id="chemName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏ã‡πÄ‡∏î‡∏µ‡∏¢‡∏°‡∏Ñ‡∏•‡∏≠‡πÑ‡∏£‡∏î‡πå"></div>
          <div class="form-group"><label for="chemFormula">‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</label><input type="text" id="chemFormula" placeholder="‡πÄ‡∏ä‡πà‡∏ô NaCl"></div>
          <div class="form-row">
            <div class="form-group"><label for="chemQuantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô *</label><input type="number" id="chemQuantity" required min="0" step="0.01" placeholder="0.00"></div>
            <div class="form-group"><label for="chemUnit">‡∏´‡∏ô‡πà‡∏ß‡∏¢ *</label><select id="chemUnit" required><option value="mL">mL</option><option value="L">L</option><option value="g">g</option><option value="kg">kg</option><option value="‡∏Ç‡∏ß‡∏î">‡∏Ç‡∏ß‡∏î</option><option value="‡∏≠‡∏±‡∏ô">‡∏≠‡∏±‡∏ô</option><option value="‡∏ä‡∏¥‡πâ‡∏ô">‡∏ä‡∏¥‡πâ‡∏ô</option><option value="‡∏´‡∏•‡∏≠‡∏î">‡∏´‡∏•‡∏≠‡∏î</option><option value="‡πÅ‡∏ó‡πà‡∏á">‡πÅ‡∏ó‡πà‡∏á</option></select></div>
          </div>
          <div class="form-group"><label for="chemLocation">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö *</label><input type="text" id="chemLocation" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏π‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ A-1"></div>
          <div class="form-group"><label for="chemMinStock">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</label><input type="number" id="chemMinStock" min="0" step="0.01" value="0" placeholder="0.00"></div>
          <button type="submit" class="btn btn-primary" data-original-text="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('addChemicalForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const data = {
        id: 'chem-' + Date.now(),
        type: 'chemical',
        name: document.getElementById('chemName').value,
        formula: document.getElementById('chemFormula').value,
        quantity: parseFloat(document.getElementById('chemQuantity').value),
        unit: document.getElementById('chemUnit').value,
        location: document.getElementById('chemLocation').value,
        minStock: parseFloat(document.getElementById('chemMinStock').value) || 0,
        createdAt: new Date().toISOString()
      };
      createItem(data);
    });
  }
  
  function editChemical(item) {
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="editChemicalForm">
          <div class="form-group"><label for="chemName">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ *</label><input type="text" id="chemName" value="${item.name}" required></div>
          <div class="form-group"><label for="chemFormula">‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</label><input type="text" id="chemFormula" value="${item.formula || ''}"></div>
          <div class="form-row">
            <div class="form-group"><label for="chemQuantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô *</label><input type="number" id="chemQuantity" value="${item.quantity}" required min="0" step="0.01"></div>
            <div class="form-group"><label for="chemUnit">‡∏´‡∏ô‡πà‡∏ß‡∏¢ *</label><select id="chemUnit" required><option value="mL" ${item.unit === 'mL' ? 'selected' : ''}>mL</option><option value="L" ${item.unit === 'L' ? 'selected' : ''}>L</option><option value="g" ${item.unit === 'g' ? 'selected' : ''}>g</option><option value="kg" ${item.unit === 'kg' ? 'selected' : ''}>kg</option><option value="‡∏Ç‡∏ß‡∏î" ${item.unit === '‡∏Ç‡∏ß‡∏î' ? 'selected' : ''}>‡∏Ç‡∏ß‡∏î</option><option value="‡∏≠‡∏±‡∏ô" ${item.unit === '‡∏≠‡∏±‡∏ô' ? 'selected' : ''}>‡∏≠‡∏±‡∏ô</option><option value="‡∏ä‡∏¥‡πâ‡∏ô" ${item.unit === '‡∏ä‡∏¥‡πâ‡∏ô' ? 'selected' : ''}>‡∏ä‡∏¥‡πâ‡∏ô</option><option value="‡∏´‡∏•‡∏≠‡∏î" ${item.unit === '‡∏´‡∏•‡∏≠‡∏î' ? 'selected' : ''}>‡∏´‡∏•‡∏≠‡∏î</option><option value="‡πÅ‡∏ó‡πà‡∏á" ${item.unit === '‡πÅ‡∏ó‡πà‡∏á' ? 'selected' : ''}>‡πÅ‡∏ó‡πà‡∏á</option></select></div>
          </div>
          <div class="form-group"><label for="chemLocation">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö *</label><input type="text" id="chemLocation" value="${item.location}" required></div>
          <div class="form-group"><label for="chemMinStock">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</label><input type="number" id="chemMinStock" value="${item.minStock || 0}" min="0" step="0.01"></div>
          <button type="submit" class="btn btn-primary" data-original-text="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('editChemicalForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const updatedItem = {
        ...item,
        name: document.getElementById('chemName').value,
        formula: document.getElementById('chemFormula').value,
        quantity: parseFloat(document.getElementById('chemQuantity').value),
        unit: document.getElementById('chemUnit').value,
        location: document.getElementById('chemLocation').value,
        minStock: parseFloat(document.getElementById('chemMinStock').value) || 0
      };
      updateItem(updatedItem);
    });
  }

  function openAddEquipmentModal() {
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="addEquipmentForm">
          <div class="form-group"><label for="equipName">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå *</label><input type="text" id="equipName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏µ‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå"></div>
          <div class="form-row">
            <div class="form-group"><label for="equipQuantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô *</label><input type="number" id="equipQuantity" required min="0" step="1" placeholder="0"></div>
            <div class="form-group"><label for="equipUnit">‡∏´‡∏ô‡πà‡∏ß‡∏¢ *</label><select id="equipUnit" required><option value="‡∏≠‡∏±‡∏ô">‡∏≠‡∏±‡∏ô</option><option value="‡∏ä‡∏¥‡πâ‡∏ô">‡∏ä‡∏¥‡πâ‡∏ô</option><option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</option><option value="‡∏ä‡∏∏‡∏î">‡∏ä‡∏∏‡∏î</option><option value="‡∏´‡∏•‡∏≠‡∏î">‡∏´‡∏•‡∏≠‡∏î</option><option value="‡πÅ‡∏ú‡πà‡∏ô">‡πÅ‡∏ú‡πà‡∏ô</option></select></div>
          </div>
          <div class="form-group"><label for="equipLocation">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö *</label><input type="text" id="equipLocation" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏π‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå B-2"></div>
          <div class="form-group"><label for="equipMinStock">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</label><input type="number" id="equipMinStock" min="0" step="1" value="0" placeholder="0"></div>
          <button type="submit" class="btn btn-primary" data-original-text="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('addEquipmentForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const data = {
        id: 'equip-' + Date.now(),
        type: 'equipment',
        name: document.getElementById('equipName').value,
        quantity: parseInt(document.getElementById('equipQuantity').value),
        unit: document.getElementById('equipUnit').value,
        location: document.getElementById('equipLocation').value,
        minStock: parseInt(document.getElementById('equipMinStock').value) || 0,
        createdAt: new Date().toISOString()
      };
      createItem(data);
    });
  }

  function editEquipment(item) {
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="editEquipmentForm">
          <div class="form-group"><label for="equipName">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå *</label><input type="text" id="equipName" value="${item.name}" required></div>
          <div class="form-row">
            <div class="form-group"><label for="equipQuantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô *</label><input type="number" id="equipQuantity" value="${item.quantity}" required min="0" step="1"></div>
            <div class="form-group"><label for="equipUnit">‡∏´‡∏ô‡πà‡∏ß‡∏¢ *</label><select id="equipUnit" required><option value="‡∏≠‡∏±‡∏ô" ${item.unit === '‡∏≠‡∏±‡∏ô' ? 'selected' : ''}>‡∏≠‡∏±‡∏ô</option><option value="‡∏ä‡∏¥‡πâ‡∏ô" ${item.unit === '‡∏ä‡∏¥‡πâ‡∏ô' ? 'selected' : ''}>‡∏ä‡∏¥‡πâ‡∏ô</option><option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á" ${item.unit === '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á' ? 'selected' : ''}>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</option><option value="‡∏ä‡∏∏‡∏î" ${item.unit === '‡∏ä‡∏∏‡∏î' ? 'selected' : ''}>‡∏ä‡∏∏‡∏î</option><option value="‡∏´‡∏•‡∏≠‡∏î" ${item.unit === '‡∏´‡∏•‡∏≠‡∏î' ? 'selected' : ''}>‡∏´‡∏•‡∏≠‡∏î</option><option value="‡πÅ‡∏ú‡πà‡∏ô" ${item.unit === '‡πÅ‡∏ú‡πà‡∏ô' ? 'selected' : ''}>‡πÅ‡∏ú‡πà‡∏ô</option></select></div>
          </div>
          <div class="form-group"><label for="equipLocation">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö *</label><input type="text" id="equipLocation" value="${item.location}" required></div>
          <div class="form-group"><label for="equipMinStock">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</label><input type="number" id="equipMinStock" value="${item.minStock || 0}" min="0" step="1"></div>
          <button type="submit" class="btn btn-primary" data-original-text="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('editEquipmentForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const updatedItem = {
        ...item,
        name: document.getElementById('equipName').value,
        quantity: parseInt(document.getElementById('equipQuantity').value),
        unit: document.getElementById('equipUnit').value,
        location: document.getElementById('equipLocation').value,
        minStock: parseInt(document.getElementById('equipMinStock').value) || 0
      };
      updateItem(updatedItem);
    });
  }

  function openAddUserModal() {
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="addUserForm">
          <div class="form-row">
            <div class="form-group"><label for="userFirstName">‡∏ä‡∏∑‡πà‡∏≠ *</label><input type="text" id="userFirstName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏ä‡∏≤‡∏¢"></div>
            <div class="form-group"><label for="userLastName">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label><input type="text" id="userLastName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏à‡∏î‡∏µ"></div>
          </div>
          <div class="form-group"><label for="userName">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô *</label><input type="text" id="userName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô teacher01"></div>
          <div class="form-group"><label for="userPassword">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô *</label><div class="input-wrapper"><input type="password" id="userPassword" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"><span class="eye-icon" onclick="toggleModalPassword(event)">${SVG_EYE_SHOW}</span></div></div>
          <div class="info-box"><p>üí° ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p></div>
          <button type="submit" class="btn btn-primary" data-original-text="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('addUserForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const data = {
        id: 'user-' + Date.now(),
        type: 'user',
        firstName: document.getElementById('userFirstName').value,
        lastName: document.getElementById('userLastName').value,
        username: document.getElementById('userName').value,
        password: document.getElementById('userPassword').value,
        role: 'teacher',
        createdAt: new Date().toISOString()
      };
      createItem(data);
    });
  }

  function editUser(item) {
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="editUserForm">
          <div class="form-row">
            <div class="form-group"><label for="userFirstName">‡∏ä‡∏∑‡πà‡∏≠ *</label><input type="text" id="userFirstName" value="${item.firstName || ''}" required></div>
            <div class="form-group"><label for="userLastName">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label><input type="text" id="userLastName" value="${item.lastName || ''}" required></div>
          </div>
          <div class="form-group"><label for="userName">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô *</label><input type="text" id="userName" value="${item.username}" required></div>
          <div class="form-group"><label for="userPassword">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô *</label><div class="input-wrapper"><input type="password" id="userPassword" value="${item.password}" required><span class="eye-icon" onclick="toggleModalPassword(event)">${SVG_EYE_SHOW}</span></div></div>
          <button type="submit" class="btn btn-primary" data-original-text="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('editUserForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const updatedItem = {
        ...item,
        firstName: document.getElementById('userFirstName').value,
        lastName: document.getElementById('userLastName').value,
        username: document.getElementById('userName').value,
        password: document.getElementById('userPassword').value
      };
      updateItem(updatedItem);
    });
  }

  function toggleModalPassword(event) {
    try {
      const eyeIcon = event.currentTarget;
      if (!eyeIcon) return;
      const passwordInput = eyeIcon.previousElementSibling; 
      if (!passwordInput || passwordInput.tagName !== 'INPUT') return;
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        eyeIcon.innerHTML = SVG_EYE_HIDE;
      } else {
        passwordInput.type = 'password';
        eyeIcon.innerHTML = SVG_EYE_SHOW;
      }
    } catch (err) { console.error(err); }
  }

  function openBorrowModal() {
    const chemicals = allData.filter(item => item.type === 'chemical' && item.quantity > 0);
    const equipment = allData.filter(item => item.type === 'equipment' && item.quantity > 0);
    const allItems = [...chemicals, ...equipment];

    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="borrowForm">
          <div class="form-group"><label for="borrowItem">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ *</label><select id="borrowItem" required onchange="updateMaxAmount()"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° --</option>${allItems.map(item => `<option value="${item.__backendId}" data-quantity="${item.quantity}" data-name="${item.name}" data-type="${item.type}" data-unit="${item.unit}">${item.name} (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${item.quantity} ${item.unit})</option>`).join('')}</select></div>
          <div class="form-group"><label for="borrowAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏° *</label<input type="number" id="borrowAmount" required min="0.01" step="any" placeholder="0.00"></div>
          <div class="form-group"><label for="borrowRoom">‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô *</label><input type="text" id="borrowRoom" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πá‡∏ö‡πÄ‡∏Ñ‡∏°‡∏µ 1"></div>
          <div class="info-box"><p>üìù ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p></div>
          <button type="submit" class="btn btn-primary" data-original-text="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('borrowForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const select = document.getElementById('borrowItem');
      if (!select.value) {
          showErrorMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°');
          submitBtn.disabled = false;
          submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°';
          return;
      }
      const selectedOption = select.options[select.selectedIndex];
      const itemId = select.value;
      const amount = parseFloat(document.getElementById('borrowAmount').value);
      const room = document.getElementById('borrowRoom').value;
      const item = allData.find(i => i.__backendId === itemId);
      
      if (!item || item.quantity < amount) {
        showErrorMessage('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠');
        submitBtn.disabled = false;
        submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°';
        return;
      }

      const borrowData = {
        id: 'borrow-' + Date.now(),
        type: 'borrow',
        borrower: currentUser.username,
        itemId: itemId,
        itemName: selectedOption.dataset.name,
        itemType: selectedOption.dataset.type,
        amount: amount,
        room: room,
        borrowDate: new Date().toISOString(),
        returnDate: null,
        status: 'pending',
        createdAt: new Date().toISOString()
      };
      
      const updatedItem = { ...item, quantity: item.quantity - amount };

      callApi('borrow', { borrowData, itemData: updatedItem }).then(onBorrowSuccess).catch(onFailure);
    });
  }

  function updateMaxAmount() {
    const select = document.getElementById('borrowItem');
    const selectedOption = select.options[select.selectedIndex];
    if (!select.value) return;
    const maxQuantity = parseFloat(selectedOption.dataset.quantity) || 0;
    const unit = selectedOption.dataset.type === 'chemical' ? '0.01' : '1';
    const amountInput = document.getElementById('borrowAmount');
    if (amountInput) {
        amountInput.max = maxQuantity;
        amountInput.step = unit;
        amountInput.placeholder = `‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${maxQuantity}`;
    }
  }

  function quickBorrowChemical(item) {
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡∏¢‡∏∑‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ: ${item.name}</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="quickBorrowForm">
          <div class="info-box"><p>üìã ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ: ${item.name} (${item.formula || '-'}) | ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${item.quantity} ${item.unit}</p></div>
          <div class="form-group"><label for="borrowAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏° *</label><input type="number" id="borrowAmount" required min="0.01" max="${item.quantity}" step="any" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${item.quantity}"></div>
          <div class="form-group"><label for="borrowRoom">‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô *</label><input type="text" id="borrowRoom" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πá‡∏ö‡πÄ‡∏Ñ‡∏°‡∏µ 1"></div>
          <button type="submit" class="btn btn-primary" data-original-text="‡∏¢‡∏∑‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ">‡∏¢‡∏∑‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('quickBorrowForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const amount = parseFloat(document.getElementById('borrowAmount').value);
      const room = document.getElementById('borrowRoom').value;
      if (amount > item.quantity) {
        showErrorMessage('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠');
        submitBtn.disabled = false;
        submitBtn.textContent = '‡∏¢‡∏∑‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ';
        return;
      }
      const borrowData = {
        id: 'borrow-' + Date.now(),
        type: 'borrow',
        borrower: currentUser.username,
        itemId: item.__backendId,
        itemName: item.name,
        itemType: item.type,
        amount: amount,
        room: room,
        borrowDate: new Date().toISOString(),
        returnDate: null,
        status: 'pending',
        createdAt: new Date().toISOString()
      };
      const updatedItem = { ...item, quantity: item.quantity - amount };
      
      callApi('borrow', { borrowData, itemData: updatedItem }).then(onBorrowSuccess).catch(onFailure);
    });
  }

  function quickBorrowEquipment(item) {
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${item.name}</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="quickBorrowForm">
          <div class="info-box"><p>üìã ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${item.name} | ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${item.quantity} ${item.unit}</p></div>
          <div class="form-group"><label for="borrowAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏° *</label><input type="number" id="borrowAmount" required min="1" max="${item.quantity}" step="any" placeholder="‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${item.quantity}"></div>
          <div class="form-group"><label for="borrowRoom">‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô *</label><input type="text" id="borrowRoom" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πá‡∏ö‡πÄ‡∏Ñ‡∏°‡∏µ 1"></div>
          <button type="submit" class="btn btn-primary" data-original-text="‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå">‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('quickBorrowForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const amount = parseInt(document.getElementById('borrowAmount').value);
      const room = document.getElementById('borrowRoom').value;
      if (amount > item.quantity) {
        showErrorMessage('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠');
        submitBtn.disabled = false;
        submitBtn.textContent = '‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå';
        return;
      }
      const borrowData = {
        id: 'borrow-' + Date.now(),
        type: 'borrow',
        borrower: currentUser.username,
        itemId: item.__backendId,
        itemName: item.name,
        itemType: item.type,
        amount: amount,
        room: room,
        borrowDate: new Date().toISOString(),
        returnDate: null,
        status: 'pending',
        createdAt: new Date().toISOString()
      };
      const updatedItem = { ...item, quantity: item.quantity - amount };
      
      callApi('borrow', { borrowData, itemData: updatedItem }).then(onBorrowSuccess).catch(onFailure);
    });
  }

  function reportOutOfStock(item) {
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏´‡∏°‡∏î: ${item.name}</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="reportOutOfStockForm">
          <div class="info-box"><p>üìã ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ: ${item.name} (${item.formula || '-'})</p></div>
          <div class="form-group"><label for="outOfStockAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î *</label><input type="number" id="outOfStockAmount" required min="0.01" step="0.01" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î"></div>
          <div class="form-group"><label for="outOfStockNote">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><textarea id="outOfStockNote" rows="3" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏û‡∏ö..."></textarea></div>
          <button type="submit" class="btn btn-danger" data-original-text="‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏´‡∏°‡∏î">‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏´‡∏°‡∏î</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('reportOutOfStockForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏à‡πâ‡∏á...';
      const outOfStockAmount = parseFloat(document.getElementById('outOfStockAmount').value);
      const note = document.getElementById('outOfStockNote').value;
      const issueReport = {
        id: 'issue-' + Date.now(),
        type: 'issue_report',
        itemId: item.__backendId,
        itemName: item.name,
        itemType: item.type,
        issueType: 'out_of_stock',
        reportedBy: currentUser.username,
        reportDate: new Date().toISOString(),
        originalAmount: outOfStockAmount,
        note: note,
        status: 'reported',
        createdAt: new Date().toISOString()
      };
      const updatedItem = {
        ...item,
        quantity: Math.max(0, item.quantity - outOfStockAmount)
      };

      callApi('create', issueReport)
        .then(response => {
          if (!response.success) return onFailure(new Error('Failed to create issue report'));
          updateItem(updatedItem); 
        })
        .catch(onFailure);
    });
  }

  function reportDamaged(item) {
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏≥‡∏£‡∏∏‡∏î: ${item.name}</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="reportDamagedForm">
          <div class="info-box"><p>üìã ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${item.name} | ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${item.quantity} ${item.unit}</p></div>
          <div class="form-group"><label for="damagedAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∏‡∏î *</label><input type="number" id="damagedAmount" required min="1" step="1" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∏‡∏î"></div>
          <div class="form-group"><label for="damagedNote">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢</label><textarea id="damagedNote" rows="3" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏û‡∏ö..."></textarea></div>
          <button type="submit" class="btn btn-danger" data-original-text="‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏≥‡∏£‡∏∏‡∏î">‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏≥‡∏£‡∏∏‡∏î</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('reportDamagedForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏à‡πâ‡∏á...';
      const damagedAmount = parseFloat(document.getElementById('damagedAmount').value);
      const note = document.getElementById('damagedNote').value;
      if (damagedAmount > item.quantity) {
          showErrorMessage('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏≥‡∏£‡∏∏‡∏î‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠');
          submitBtn.disabled = false;
          submitBtn.textContent = '‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏≥‡∏£‡∏∏‡∏î';
          return;
      }
      const issueReport = {
        id: 'issue-' + Date.now(),
        type: 'issue_report',
        itemId: item.__backendId,
        itemName: item.name,
        itemType: item.type,
        issueType: 'damaged',
        reportedBy: currentUser.username,
        reportDate: new Date().toISOString(),
        damagedAmount: damagedAmount,
        note: note,
        status: 'reported',
        createdAt: new Date().toISOString()
      };
      const updatedItem = {
        ...item,
        quantity: Math.max(0, item.quantity - damagedAmount),
        damagedQuantity: (item.damagedQuantity || 0) + damagedAmount,
        status: item.quantity - damagedAmount > 0 ? item.status : 'damaged',
        damageNote: note
      };

      callApi('create', issueReport)
        .then(response => {
          if (!response.success) return onFailure(new Error('Failed to create issue report'));
          updateItem(updatedItem);
        })
        .catch(onFailure);
    });
  }

  // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°
  function reportIssueFromBorrow(borrowItem) {
    const item = allData.find(i => i.__backendId === borrowItem.itemId);
    if (!item) return;

    if(!modalElement) modalElement = document.getElementById('modal');
    const buttonText = item.type === 'chemical' ? '‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏´‡∏°‡∏î' : '‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏≥‡∏£‡∏∏‡∏î/‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢';
    const issueTypeText = item.type === 'chemical' ? '‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏´‡∏°‡∏î' : '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏≥‡∏£‡∏∏‡∏î/‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢';
    const step = item.type === 'chemical' ? '0.01' : '1';
            
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>${buttonText}: ${item.name}</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="reportIssueForm">
          <div class="info-box"><p>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°: ${item.name} | ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${borrowItem.amount} ${item.unit}</p></div>
          <div class="form-group"><label for="issueAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà${issueTypeText} *</label><input type="number" id="issueAmount" required min="${step}" max="${borrowItem.amount}" step="${step}" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà${issueTypeText}" oninput="updateRemainingAmount(${borrowItem.amount}, ${item.type === 'chemical' ? 2 : 0})"></div>
          <div class="info-box" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: #f59e0b;"><p id="remainingInfo">üí° ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô: <span id="remainingAmount">${borrowItem.amount}</span> ${item.unit}</p></div>
          <div class="form-group"><label for="issueNote">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤</label><textarea id="issueNote" rows="3" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö..."></textarea></div>
          <button type="submit" class="btn btn-danger" data-original-text="${buttonText}">${buttonText}</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');
  
    window.updateRemainingAmount = (originalAmount, decimals) => {
        const issueAmount = parseFloat(document.getElementById('issueAmount').value) || 0;
        const remaining = Math.max(0, originalAmount - issueAmount);
        document.getElementById('remainingAmount').textContent = remaining.toFixed(decimals);
    };

    document.getElementById('reportIssueForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏à‡πâ‡∏á...';
      const issueAmount = parseFloat(document.getElementById('issueAmount').value);
      const note = document.getElementById('issueNote').value;
      const remainingAmount = Math.max(0, borrowItem.amount - issueAmount);
      
      if (issueAmount > borrowItem.amount) {
          showErrorMessage('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°');
          submitBtn.disabled = false;
          submitBtn.textContent = buttonText;
          return;
      }

      const issueReport = {
        id: 'issue-' + Date.now(),
        type: 'issue_report',
        itemId: item.__backendId,
        itemName: item.name,
        itemType: item.type,
        issueType: item.type === 'chemical' ? 'out_of_stock' : 'damaged',
        reportedBy: currentUser.username,
        reportDate: new Date().toISOString(),
        borrowId: borrowItem.__backendId,
        originalAmount: borrowItem.amount,
        [item.type === 'chemical' ? 'outOfStockAmount' : 'damagedAmount']: issueAmount,
        note: note,
        status: 'reported',
        createdAt: new Date().toISOString()
      };

      const updatedBorrow = {
        ...borrowItem,
        amount: remainingAmount,
        issueReported: true,
        issueAmount: issueAmount,
        issueNote: note
      };

      callApi('create', issueReport)
        .then(response => {
          if (!response.success) return onFailure(new Error('Failed to create issue report'));
          // ‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
          onCrudSuccess(response);
          updateItem(updatedBorrow);
        })
        .catch(onFailure);
    });
  }

  // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°
  function editBorrow(item) {
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="editBorrowForm">
          <div class="form-group"><label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</label><input type="text" value="${item.itemName}" disabled></div>
          <div class="form-group"><label for="editAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏° *</label><input type="number" id="editAmount" value="${item.amount}" required min="0.01" step="any"></div>
          <div class="form-group"><label for="editRoom">‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô *</label><input type="text" id="editRoom" value="${item.room}" required></div>
          <div class="form-group"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</label><input type="text" value="${new Date(item.borrowDate).toLocaleString('th-TH')}" disabled></div>
          <button type="submit" class="btn btn-primary" data-original-text="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('editBorrowForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const newAmount = parseFloat(document.getElementById('editAmount').value);
      const originalAmount = item.amount;
      const difference = newAmount - originalAmount;
      const updatedBorrow = {
        ...item,
        amount: newAmount,
        room: document.getElementById('editRoom').value
      };
      if (difference === 0) {
        updateItem(updatedBorrow);
        return;
      }
      const currentItem = allData.find(i => i.__backendId === item.itemId);
      if (!currentItem) {
          showErrorMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å');
          submitBtn.disabled = false;
          submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
          return;
      }
      if (difference > 0 && currentItem.quantity < difference) {
        showErrorMessage('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏∑‡∏°');
        submitBtn.disabled = false;
        submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
        return;
      }
      const updatedItem = {
        ...currentItem,
        quantity: currentItem.quantity - difference 
      };

      callApi('update', updatedItem)
        .then(response => {
            if (!response.success) return onFailure(new Error('Failed to update item stock'));
            // ‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            onCrudSuccess(response);
            updateItem(updatedBorrow);
        })
        .catch(onFailure);
    });
  }

  // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô
  function returnItem(borrow) {
    const item = allData.find(i => i.__backendId === borrow.itemId);
    if (!item) return;

    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡∏Ñ‡∏∑‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${item.name}</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="returnForm">
          <div class="info-box"><p>üìã ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°: ${borrow.amount} ${item.unit}</p></div>
          <div class="form-group"><label for="returnAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô *</label><input type="number" id="returnAmount" value="${borrow.amount}" required min="0" max="${borrow.amount}" step="any" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô"></div>
          <div class="form-group"><label for="returnNote">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô</label><textarea id="returnNote" rows="2" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)..."></textarea></div>
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button type="submit" class="btn btn-success" data-original-text="‡∏Ñ‡∏∑‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">‡∏Ñ‡∏∑‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
          </div>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('returnForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const returnAmount = parseFloat(document.getElementById('returnAmount').value);
      const returnNote = document.getElementById('returnNote').value;
      const updatedBorrow = {
        ...borrow,
        returnDate: new Date().toISOString(),
        status: 'returned',
        actualReturnAmount: returnAmount,
        returnNote: returnNote
      };
      const updatedItem = {
        ...item,
        quantity: item.quantity + returnAmount
      };

      callApi('update', updatedBorrow)
        .then(response => {
            if (!response.success) return onFailure(new Error('Failed to update borrow record'));
            // ‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            onCrudSuccess(response);
            updateItem(updatedItem);
        })
        .catch(onFailure);
    });
  }

  function showErrorMessage(message) {
    const existingError = document.querySelector('.error-toast');
    if(existingError) document.body.removeChild(existingError);
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message error-toast';
    errorDiv.textContent = `‚ùå ${message}`;
    errorDiv.style.position = 'fixed';
    errorDiv.style.top = '20px';
    errorDiv.style.right = '20px';
    errorDiv.style.zIndex = '9999';
    errorDiv.style.maxWidth = '300px';
    errorDiv.style.boxShadow = '0 10px 20px rgba(0,0,0,0.1)';
    document.body.appendChild(errorDiv);
    setTimeout(() => {
      if (errorDiv.parentNode && errorDiv.parentNode === document.body) {
        document.body.removeChild(errorDiv);
      }
    }, 5000);
  }

  function filterRows(tableId, searchTerm) {
      const table = document.getElementById(tableId);
      if (!table) return;
      const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
      let found = false;
      for (let row of rows) {
          if (row.classList.contains('empty-state')) continue;
          const text = row.textContent.toLowerCase(); 
          if (text.includes(searchTerm)) {
              row.style.display = '';
              found = true;
          } else {
              row.style.display = 'none';
          }
      }
      const emptyStateRow = table.querySelector('.empty-state');
      if (emptyStateRow) {
          emptyStateRow.style.display = found ? 'none' : 'table-row';
      }
  }

  function filterByName(tableId, inputId) {
      const searchTerm = document.getElementById(inputId).value.toLowerCase();
      const table = document.getElementById(tableId);
      if (!table) return;
      const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
      let found = false;
      for (let row of rows) {
          if (row.classList.contains('empty-state')) continue;
          const cell = row.getElementsByTagName('td')[0]; 
          const text = cell ? cell.textContent.toLowerCase() : '';
          if (text.includes(searchTerm)) {
              row.style.display = '';
              found = true;
          } else {
              row.style.display = 'none';
          }
      }
      const emptyStateRow = table.querySelector('.empty-state');
      if (emptyStateRow) emptyStateRow.style.display = found ? 'none' : 'table-row';
  }

  function filterReports() {
    const searchTerm = document.getElementById('reportSearch').value.toLowerCase();
    const container = document.getElementById('reportAccordionContainer');
    if (!container) return;
    const cards = container.querySelectorAll('.report-group-card');
    let found = false;
    for (let card of cards) {
      const text = card.textContent.toLowerCase(); 
      if (text.includes(searchTerm)) {
        card.style.display = '';
        found = true;
      } else {
        card.style.display = 'none';
      }
    }
    const emptyState = container.querySelector('.empty-state');
    if(emptyState) {
        emptyState.style.display = found ? 'none' : 'block';
    }
  }

  function filterChemicals() { filterByName('chemicalsTable', 'chemicalSearch'); }
  function filterEquipment() { filterByName('equipmentTable', 'equipmentSearch'); }
  function filterTeacherChemicals() { filterByName('teacherChemicalsTable', 'chemicalSearchTeacher'); }
  function filterTeacherEquipment() { filterByName('teacherEquipmentTable', 'equipmentSearchTeacher'); }
  
  function resolveChemicalIssue(report, item) {
    if (!report || !item) {
        showErrorMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
        return;
    }
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ: ${item.name}</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="restockForm">
          <div class="info-box"><p>üìã ‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á: ${report.reportedBy} | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á: ${new Date(report.reportDate).toLocaleDateString('th-TH')}</p></div>
          <div class="form-group"><label for="restockAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏¥‡∏° *</label><input type="number" id="restockAmount" required min="0.01" step="0.01" placeholder="0.00"></div>
          <div class="form-group"><label for="restockNote">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</label><textarea id="restockNote" rows="2" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å..."></textarea></div>
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button type="submit" class="btn btn-success" data-original-text="‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å">‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
          </div>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('restockForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const restockAmount = parseFloat(document.getElementById('restockAmount').value);
      const restockNote = document.getElementById('restockNote').value;
      const updatedItem = {
        ...item,
        quantity: item.quantity + restockAmount
      };
      const resolvedReport = {
        ...report,
        status: 'resolved',
        resolvedDate: new Date().toISOString(),
        resolvedNote: restockNote,
        restockAmount: restockAmount
      };
      
      callApi('update', updatedItem)
        .then(response => {
            if (!response.success) return onFailure(new Error('Failed to update item stock'));
            updateItem(resolvedReport);
        })
        .catch(onFailure);
    });
  }

  function markIssueResolved(report) {
    if (!report) return;
    const resolvedReport = {
      ...report,
      status: 'resolved',
      resolvedDate: new Date().toISOString()
    };
    updateItem(resolvedReport);
  }

  function resolveEquipmentIssue(report, item) {
    if (!report || !item) {
        showErrorMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
        return;
    }
    const damagedAmount = report.damagedAmount || 0;
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${item.name}</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="repairForm">
          <div class="info-box"><p>üìã ‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á: ${report.reportedBy} | ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏≥‡∏£‡∏∏‡∏î: ${damagedAmount} ${item.unit}</p></div>
          <div class="form-group"><label for="repairedAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏î‡πâ *</label><input type="number" id="repairedAmount" required min="0" max="${damagedAmount}" step="1" value="${damagedAmount}"></div>
          <div class="form-group"><label for="repairNote">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°</label><textarea id="repairNote" rows="2" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°..."></textarea></div>
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button type="submit" class="btn btn-success" data-original-text="‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à">‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à</button>
          </div>
        </form>
      </div>
    `;
    modalElement.classList.add('active');

    document.getElementById('repairForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      const repairedAmount = parseFloat(document.getElementById('repairedAmount').value);
      const repairNote = document.getElementById('repairNote').value;
      const updatedItem = {
        ...item,
        quantity: item.quantity + repairedAmount,
        damagedQuantity: Math.max(0, (item.damagedQuantity || 0) - repairedAmount)
      };
      if (updatedItem.damagedQuantity === 0) {
        updatedItem.status = 'normal';
        updatedItem.damageNote = '';
      }
      const resolvedReport = {
        ...report,
        status: 'resolved',
        resolvedDate: new Date().toISOString(),
        resolvedNote: repairNote,
        repairedAmount: repairedAmount
      };
      
      callApi('update', updatedItem)
        .then(response => {
            if (!response.success) return onFailure(new Error('Failed to update item stock'));
            updateItem(resolvedReport);
        })
        .catch(onFailure);
    });
  }
  
  function viewEquipmentDetails(itemId) {
    const item = allData.find(i => i.__backendId === itemId);
    if (!item) return;
    const damageReports = allData.filter(report => report.type === 'issue_report' && report.itemId === itemId && report.issueType === 'damaged' && report.status !== 'resolved');
    const totalReportedDamage = damageReports.reduce((sum, report) => sum + (report.damagedAmount || 0), 0);
    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${item.name}</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <div style="padding: 20px 0;">
          <div class="info-box" style="margin-bottom: 16px;"><p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö):</strong> ${item.quantity + totalReportedDamage} ${item.unit}</p></div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;"><div><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ:</label><div style="font-size: 18px; font-weight: 600; color: #059669;">${item.quantity} ${item.unit}</div></div><div><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏≥‡∏£‡∏∏‡∏î (‡∏£‡∏≠‡∏ã‡πà‡∏≠‡∏°):</label><div style="font-size: 18px; font-weight: 600; color: #dc2626;">${totalReportedDamage} ${item.unit}</div></div></div>
          ${damageReports.length > 0 ? `<div style="margin-bottom: 20px;"><label style="font-weight: 600; margin-bottom: 8px; display: block;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∏‡∏î:</label><div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 12px; max-height: 150px; overflow-y: auto;">${damageReports.map(report => `<div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #fed7d7;"><div style="font-size: 14px;"><strong>‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á:</strong> ${report.reportedBy} | <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${new Date(report.reportDate).toLocaleDateString('th-TH')} | <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</strong> <span style="color: #dc2626; font-weight: 600;">${report.damagedAmount} ${item.unit}</span></div>${report.note ? `<div style="font-size: 13px; color: #6b7280; margin-top: 4px;"><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${report.note}</div>` : ''}</div>`).join('')}</div></div>` : ''}
          <div style="margin-bottom: 16px;"><label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö:</label><div>${item.location}</div></div>
          <div style="margin-bottom: 16px;"><label>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥:</label><div>${item.minStock || 0} ${item.unit}</div></div>
        </div>
        <div style="text-align: center;"><button class="btn btn-secondary" onclick="closeModal()">‡∏õ‡∏¥‡∏î</button></div>
      </div>
    `;
    modalElement.classList.add('active');
  }

  function downloadBorrowReport(format) {
    const borrows = allData.filter(item => item.type === 'borrow');
    borrows.sort((a, b) => (a.borrower || '').localeCompare(b.borrower || ''));
    const title = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô';
    const filename = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}`;
    const reportData = borrows.map(item => ({ '‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°': item.borrower, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£': item.itemName, '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó': item.itemType === 'chemical' ? '‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ' : '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': item.amount, '‡∏´‡πâ‡∏≠‡∏á': item.room, '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°': new Date(item.borrowDate).toLocaleDateString('th-TH'), '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô': item.returnDate ? new Date(item.returnDate).toLocaleDateString('th-TH') : '-', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': item.status === 'returned' ? '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô' }));
    const headers = ['‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', '‡∏´‡πâ‡∏≠‡∏á', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'];
    if (reportData.length === 0) {
        showErrorMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
        return;
    }
    if (format === 'excel') {
        downloadExcel(reportData, filename);
    } else if (format === 'pdf') {
        downloadPDF(reportData, title, filename, headers); 
    }
  }

  function downloadInventoryReport(type, format) {
    const chemicals = allData.filter(item => item.type === 'chemical');
    const equipment = allData.filter(item => item.type === 'equipment');
    let reportData = [];
    let title = '';
    let filename = '';
    let headers = null;

    switch (type) {
      case 'all_chemicals': {
        reportData = chemicals.map(item => ({ '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ': item.name, '‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ': item.formula || '-', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠': item.quantity, '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥': item.minStock || 0, '‡∏´‡∏ô‡πà‡∏ß‡∏¢': item.unit, '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö': item.location, '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': item.quantity <= (item.minStock || 0) ? '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥' : '‡∏õ‡∏Å‡∏ï‡∏¥' }));
        title = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
        filename = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}`;
        headers = ['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ', '‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥', '‡∏´‡∏ô‡πà‡∏ß‡∏¢', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'];
        break;
      }
      case 'all_equipment': {
        reportData = equipment.map(item => ({ '‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå': item.name, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠': item.quantity, '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥': item.minStock || 0, '‡∏´‡∏ô‡πà‡∏ß‡∏¢': item.unit, '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö': item.location, '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': item.quantity <= (item.minStock || 0) ? '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥' : '‡∏õ‡∏Å‡∏ï‡∏¥' }));
        title = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
        filename = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}`;
        headers = ['‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥', '‡∏´‡∏ô‡πà‡∏ß‡∏¢', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'];
        break;
      }
      case 'available_chemicals': {
        const availableChemicals = chemicals.filter(item => item.quantity > 0);
        reportData = availableChemicals.map(item => ({ '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ': item.name, '‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ': item.formula || '-', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠': item.quantity, '‡∏´‡∏ô‡πà‡∏ß‡∏¢': item.unit, '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö': item.location }));
        title = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠';
        filename = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}`;
        headers = ['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ', '‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '‡∏´‡∏ô‡πà‡∏ß‡∏¢', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö'];
        break;
      }
      case 'available_equipment': {
        const availableEquipment = equipment.filter(item => item.quantity > 0);
        reportData = availableEquipment.map(item => ({ '‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå': item.name, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠': item.quantity, '‡∏´‡∏ô‡πà‡∏ß‡∏¢': item.unit, '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö': item.location }));
        title = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠';
        filename = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}`;
        headers = ['‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '‡∏´‡∏ô‡πà‡∏ß‡∏¢', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö'];
        break;
      }
      case 'reorder_chemicals': {
        title = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°';
        filename = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ-‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}`;
        const reorderItems = chemicals.filter(item => item.quantity <= (item.minStock || 0));
        reportData = reorderItems.map(item => ({ '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ': item.name, '‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ': item.formula || '-', '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥': item.minStock || 0, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠': item.quantity, '‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢)': Math.max(0, (item.minStock || 0) - item.quantity + 1), '‡∏´‡∏ô‡πà‡∏ß‡∏¢': item.unit }));
        headers = ['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ', '‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ', '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢)', '‡∏´‡∏ô‡πà‡∏ß‡∏¢'];
        break;
      }
      case 'reorder_equipment': {
        title = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°';
        filename = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå-‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}`;
        const reorderItems = equipment.filter(item => item.quantity <= (item.minStock || 0));
        reportData = reorderItems.map(item => ({ '‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå': item.name, '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥': item.minStock || 0, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠': item.quantity, '‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢)': Math.max(0, (item.minStock || 0) - item.quantity + 1), '‡∏´‡∏ô‡πà‡∏ß‡∏¢': item.unit }));
        headers = ['‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢)', '‡∏´‡∏ô‡πà‡∏ß‡∏¢'];
        break;
      }
    }
    
    if (reportData.length === 0) {
        showErrorMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
        return;
    }
    if (format === 'excel') {
        downloadExcel(reportData, filename);
    } else if (format === 'pdf') {
        downloadPDF(reportData, title, filename, headers); 
    }
  }

  function downloadExcel(data, filename) {
    if (data.length === 0) {
      showErrorMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
      return;
    }
    const headers = Object.keys(data[0]);
    const csvContent = [
      headers.join(','),
      ...data.map(row => headers.map(header => {
        const value = row[header];
        if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
          return `"${value.replace(/"/g, '""')}"`;
        }
        return value;
      }).join(','))
    ].join('\n');
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `${filename}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function downloadPDF(data, title, filename, headers = null) {
    const hasData = Array.isArray(data) ? data.length > 0 : false;
    if (!hasData) {
      showErrorMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
      return;
    }
    const systemTitle = defaultConfig.system_title;
    const printWindow = window.open('', '_blank');
    printWindow.document.write('<html><head><title>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...</title><style>body{font-family: Sarabun, sans-serif; text-align: center; padding-top: 50px;} h2{color: #60a5fa;}</style></head><body><h2>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå...</h2><p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p></body></html>');
    printWindow.document.close();

    callApi('getPdf', { reportData: data, title, systemTitle, headers })
      .then(response => {
        if (!response.html) { throw new Error('No HTML content returned'); }
        printWindow.document.open();
        printWindow.document.write(response.html);
        printWindow.document.close();
        printWindow.onload = function() { setTimeout(() => { printWindow.focus(); printWindow.print(); }, 500); };
      })
      .catch(error => { printWindow.close(); onFailure(error); });
  }

  // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á Welcome Popup
  function showWelcomeToast(name, role) {
    const existingToast = document.querySelector('.welcome-toast');
    if (existingToast) existingToast.remove();

    const icon = role === 'admin' ? 'üë®‚Äçüíª' : 'üë®‚Äçüè´';
    const roleText = role === 'admin' ? '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö' : '‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô';

    const toast = document.createElement('div');
    toast.className = 'welcome-toast';
    toast.innerHTML = `
      <div class="welcome-icon-circle">${icon}</div>
      <div class="welcome-content">
          <span class="welcome-title">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, ${roleText}</span>
          <span class="welcome-name">${name}</span>
      </div>
    `;

    document.body.appendChild(toast);
    requestAnimationFrame(() => { toast.classList.add('show'); });
    setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 600); }, 3500);
  }
</script>
 </body>
</html>
