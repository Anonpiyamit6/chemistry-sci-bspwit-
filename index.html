<!DOCTYPE html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartLab Chemical Inventory System</title>
  
  <!-- [‡πÄ‡∏û‡∏¥‡πà‡∏°] Library ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
        body { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Sarabun', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #bae6fd 100%); min-height: 100%; line-height: 1.6; }
        * { box-sizing: border-box; }
        .container { max-width: 1200px; margin: 0 auto; padding: 16px; display: flex; flex-direction: column; min-height: 96vh; }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-box { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); padding: 40px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.15); width: 100%; max-width: 420px; border: 1px solid rgba(255, 255, 255, 0.3); }
        .logo-container { text-align: center; margin-bottom: 32px; }
        .logo { width: 80px; height: 80px; margin: 0 auto 16px; background: transparent; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 36px; box-shadow: none; }
        .logo img { width: 100%; height: 100%; object-fit: contain; border-radius: 20px; }
        h1 { color: #1f2937; margin: 0 0 8px 0; font-size: 26px; text-align: center; font-weight: 600; letter-spacing: -0.3px; }
        .subtitle { color: #6b7280; text-align: center; margin-bottom: 32px; font-size: 15px; line-height: 1.5; font-weight: 400; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #374151; font-weight: 500; font-size: 14px; }
        .input-wrapper { position: relative; }
        input[type="text"], input[type="password"], input[type="number"], select, textarea { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 15px; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); font-family: inherit; }
        input[type="password"] { padding-right: 48px; }
        .eye-icon { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 18px; color: #6b7280; user-select: none; transition: color 0.2s; }
        .eye-icon svg { width: 18px; height: 18px; }
        .eye-icon:hover { color: #374151; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #93c5fd; box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.1); background: white; }
        .btn { padding: 12px 24px; border: none; border-radius: 12px; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; font-family: inherit; position: relative; overflow: hidden; }
        .btn:before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; }
        .btn:hover:before { left: 100%; }
        .btn-primary { background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%); color: white; box-shadow: 0 4px 12px rgba(147, 197, 253, 0.3); width: 100%; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(147, 197, 253, 0.4); }
        .btn-secondary { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); color: #475569; border: 1px solid #e2e8f0; }
        .btn-secondary:hover { background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%); transform: translateY(-1px); }
        .btn-danger { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3); }
        .btn-danger:hover { background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%); transform: translateY(-1px); }
        .btn-success { background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3); }
        .btn-success:hover { background: linear-gradient(135deg, #047857 0%, #065f46 100%); transform: translateY(-1px); }
        
        /* [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Word */
        .btn-info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .btn-info:hover { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); transform: translateY(-1px); }

        .btn-small { padding: 8px 16px; font-size: 13px; margin: 0 4px; border-radius: 10px; }
        .error-message { background: #fef2f2; color: #dc2626; padding: 12px; border-radius: 10px; margin-bottom: 16px; font-size: 14px; text-align: center; border: 1px solid #fecaca; }
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        .header { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); padding: 20px 24px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; border: 1px solid rgba(255, 255, 255, 0.3); }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-logo { width: 48px; height: 48px; background: transparent; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: none; }
        .header-logo img { width: 100%; height: 100%; object-fit: contain; border-radius: 14px; }
        .header-info h2 { margin: 0; color: #1f2937; font-size: 22px; font-weight: 600; letter-spacing: -0.3px; }
        .header-info p { margin: 4px 0 0 0; color: #6b7280; font-size: 14px; font-weight: 400; }
        .header-right { display: flex; gap: 8px; align-items: center; }
        .nav-tabs { display: flex; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); padding: 8px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); border: 1px solid rgba(255, 255, 255, 0.3); }
        .nav-tab { padding: 10px 20px; border: none; background: transparent; color: #6b7280; font-size: 14px; font-weight: 500; cursor: pointer; border-radius: 12px; transition: all 0.3s ease; position: relative; overflow: hidden; font-family: inherit; flex-grow: 1; text-align: center; }
        .nav-tab:hover { background: rgba(147, 197, 253, 0.1); color: #60a5fa; }
        .nav-tab.active { background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%); color: white; box-shadow: 0 4px 12px rgba(147, 197, 253, 0.3); }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .stat-card { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); padding: 24px; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); border: 1px solid rgba(255, 255, 255, 0.3); transition: transform 0.3s ease; }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-card h3 { margin: 0 0 12px 0; color: #6b7280; font-size: 14px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card .number { font-size: 32px; font-weight: 700; color: #60a5fa; margin: 0; background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .card { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); padding: 24px; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); margin-bottom: 24px; border: 1px solid rgba(255, 255, 255, 0.3); }
        .card h3 { margin: 0 0 20px 0; color: #1f2937; font-size: 20px; font-weight: 600; letter-spacing: -0.3px; }
        .search-box { margin-bottom: 20px; }
        .search-box input { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 15px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); transition: all 0.3s ease; font-family: inherit; }
        .search-box input:focus { outline: none; border-color: #93c5fd; box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.1); background: white; }
        .table-container { overflow-x: auto; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.08); border: 1px solid rgba(255, 255, 255, 0.2); background: white; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 700px; background: white; font-size: 13px; border-radius: 16px; overflow: hidden; }
        th { background: #93c5fd; padding: 14px 12px; text-align: left; font-weight: 600; color: white; border: none; font-size: 13px; letter-spacing: 0.2px; position: relative; }
        th:first-child { border-top-left-radius: 16px; }
        th:last-child { border-top-right-radius: 16px; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; color: #475569; font-weight: 400; background: white; transition: all 0.2s ease; font-size: 13px; }
        tr:hover td { background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); transform: scale(1.001); }
        tr:last-child td { border-bottom: none; }
        tr:last-child td:first-child { border-bottom-left-radius: 16px; }
        tr:last-child td:last-child { border-bottom-right-radius: 16px; }
        .badge { display: inline-block; padding: 6px 12px; border-radius: 10px; font-size: 12px; font-weight: 500; letter-spacing: 0.25px; }
        .badge-low { background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); color: #dc2626; border: 1px solid #fecaca; }
        .badge-normal { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); color: #60a5fa; border: 1px solid #bfdbfe; }
        .badge-pending { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); color: #d97706; border: 1px solid #fed7aa; }
        .badge-returned { background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%); color: #a16207; border: 1px solid #fed7aa; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); z-index: 1000; overflow-y: auto; padding: 20px; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); padding: 32px; border-radius: 20px; max-width: 560px; width: 100%; max-height: 90%; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.15); border: 1px solid rgba(255, 255, 255, 0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-header h3 { margin: 0; color: #1f2937; font-size: 20px; font-weight: 600; letter-spacing: -0.3px; }
        .close-btn { background: rgba(107, 114, 128, 0.1); border: none; font-size: 20px; cursor: pointer; color: #6b7280; padding: 0; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 10px; transition: all 0.2s; }
        .close-btn:hover { background: rgba(107, 114, 128, 0.2); color: #374151; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .loading { text-align: center; padding: 20px; color: #6b7280; font-size: 14px; }
        .empty-state { text-align: center; padding: 40px 20px; color: #9ca3af; font-size: 14px; }
        .empty-state-icon { font-size: 48px; margin-bottom: 16px; }
        .academic-header { background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%); color: white; padding: 16px 24px; border-radius: 16px 16px 0 0; margin: -24px -24px 20px -24px; }
        .academic-header h3 { margin: 0; font-size: 18px; font-weight: 600; color: white; }
        .section-divider { height: 1px; background: linear-gradient(90deg, transparent, #e5e7eb, transparent); margin: 24px 0; }
        .info-box { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid #bfdbfe; padding: 16px; border-radius: 12px; margin-bottom: 20px; }
        .info-box p { margin: 0; color: #60a5fa; font-size: 14px; font-weight: 500; }
        @media (max-width: 768px) {
            .container { padding: 12px; }
            .form-row { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; gap: 16px; }
            .header { flex-direction: column; align-items: flex-start; padding: 16px 20px; }
            .header-right { width: 100%; justify-content: space-between; }
            .nav-tabs { overflow-x: auto; flex-wrap: nowrap; padding: 6px; gap: 6px; }
            .nav-tab { white-space: nowrap; padding: 8px 16px; font-size: 13px; flex-grow: 0; text-align: left; }
            .modal-content { padding: 24px; margin: 10px; }
            .login-box { padding: 32px 24px; margin: 10px; }
            h1 { font-size: 22px; }
            .card { padding: 20px; }
            table { min-width: 600px; }
            th, td { padding: 10px 6px; font-size: 12px; }
        }
        @media (max-width: 480px) {
            .btn-small { padding: 6px 12px; font-size: 12px; margin: 2px; }
            .stats-grid { gap: 12px; }
            .stat-card { padding: 20px; }
            .stat-card .number { font-size: 28px; }
        }
        .report-group-card { background: #fff; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; overflow: hidden; }
        .report-group-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; cursor: pointer; background: #f8fafc; transition: background 0.2s ease; }
        .report-group-header:hover { background: #f1f5f9; }
        .report-group-header h4 { margin: 0; color: #1f2937; font-size: 16px; display: flex; align-items: center; gap: 10px; }
        .report-group-header .stats { font-size: 13px; color: #6b7280; flex-shrink: 0; margin-left: 16px; }
        .report-group-header .toggle-icon { font-size: 20px; color: #60a5fa; font-weight: bold; transform: rotate(0deg); transition: transform 0.3s ease; }
        .report-group-header.open .toggle-icon { transform: rotate(90deg); }
        .report-group-details { display: none; padding: 0px; border-top: 1px solid #e5e7eb; background: #fff; }
        .report-group-details .table-container { box-shadow: none; border: none; border-radius: 0; }
        .report-group-details table th { background: #f0f9ff; color: #0c4a6e; }
        .page-footer { text-align: center; padding: 24px 0; margin-top: auto; color: #718096; font-size: 13px; font-weight: 500; border-top: 1px solid #cbd5e1; background-color: #f8fafc; border-radius: 12px; margin-left: -16px; margin-right: -16px; padding-left: 16px; padding-right: 16px; }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡πâ) */
        .btn-logout { transition: all 0.3s ease; }
        .btn-logout:hover {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            color: white !important;
            border: 1px solid #dc2626 !important;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
            transform: translateY(-1px);
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Welcome Toast */
        .welcome-toast {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%) translateY(-150%);
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            padding: 12px 28px 12px 20px; border-radius: 50px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1), 0 0 0 1px rgba(255,255,255,0.6);
            display: flex; align-items: center; gap: 16px; z-index: 9999;
            opacity: 0; transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); min-width: 300px;
        }
        .welcome-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .welcome-icon-circle { width: 44px; height: 44px; background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; box-shadow: 0 4px 12px rgba(96, 165, 250, 0.4); }
        .welcome-content { display: flex; flex-direction: column; }
        .welcome-title { font-family: 'Sarabun', sans-serif; font-size: 14px; color: #64748b; font-weight: 500; margin-bottom: 2px; }
        .welcome-name { font-family: 'Sarabun', sans-serif; font-size: 16px; color: #1e293b; font-weight: 700; }
  </style>

  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div id="app"></div>
  
  <!-- [‡πÄ‡∏û‡∏¥‡πà‡∏°] Input File ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Import Excel -->
  <input type="file" id="excelInput" accept=".xlsx, .xls" style="display: none;" onchange="handleExcelUpload(event)">

  <script>
  // [IMPORTANT] ‡πÉ‡∏™‡πà URL Web App ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
  const API_URL = "https://script.google.com/macros/s/AKfycbxXd30mi6wPOKskw8A-yuUCwRf6YybXhqYdOotTg_i2Y5DhRvI7ZY-t3X7dMD_tCtkjUw/exec";

  async function callApi(action, payload = {}) {
    try {
      const response = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ action: action, data: payload }),
        headers: { "Content-Type": "text/plain;charset=utf-8" },
      });
      return await response.json();
    } catch (error) {
      console.error("API Error:", error);
      throw error;
    }
  }

  const SVG_EYE_SHOW = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-fill" viewBox="0 0 16 16"><path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/><path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/></svg>';
  const SVG_EYE_HIDE = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye-slash-fill" viewBox="0 0 16 16"><path d="m10.79 12.912-1.614-1.615a3.5 3.5 0 0 1-4.474-4.474l-2.06-2.06C.938 6.278 0 8 0 8s3 5.5 8 5.5a7.029 7.029 0 0 0 2.79-.588zM5.21 3.088A7.028 7.028 0 0 1 8 2.5c5 0 8 5.5 8 5.5s-.939 1.721-2.641 3.238l-2.062-2.062a3.5 3.5 0 0 0-4.474-4.474L5.21 3.089z"/><path d="M5.525 7.646a2.5 2.5 0 0 0 2.829 2.829l-2.83-2.829zm4.95.708-2.829-2.83a2.5 2.5 0 0 1 2.829 2.829zm3.171 6-12-12 .708-.708 12 12-.708.708z"/></svg>';

  const defaultConfig = {
    system_title: '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ ‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£',
    logo_url: 'https://img5.pic.in.th/file/secure-sv1/-205c460e57efb3b52b.png',
    welcome_message: '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ'
  };
  let currentUser = null;
  let allData = [];
  let currentView = 'login';
  let currentTab = 'dashboard';

  let appElement;
  let modalElement;
  let loginButtonElement;
  let loginErrorElement;

  document.addEventListener('DOMContentLoaded', init);

  function init() {
    console.log('App initializing...');
    appElement = document.getElementById('app');
    
    // 1. ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å LocalStorage ‡∏Å‡πà‡∏≠‡∏ô
    const cachedData = localStorage.getItem('smartlab_local_data');
    
    if (cachedData) {
      try {
        allData = JSON.parse(cachedData);
        console.log('Loaded from Cache:', allData.length);
        initializeDefaultAdmin(); // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ Login ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        
        // ‡πÅ‡∏≠‡∏ö Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á
        callApi('sync')
          .then(response => {
            if (response.success && response.data) {
              allData = response.data;
              localStorage.setItem('smartlab_local_data', JSON.stringify(allData));
              if (currentView !== 'login') {
                renderDashboard();
              }
            }
          })
          .catch(err => console.warn('Background sync failed:', err));
          
      } catch (e) {
        localStorage.removeItem('smartlab_local_data');
        startFreshSync();
      }
    } else {
      startFreshSync();
    }
  }

  function startFreshSync() {
    appElement.innerHTML = `<div class="login-container"><div class="login-box" style="text-align: center;"><h2>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå...</h2></div></div>`;
    callApi('sync').then(onSyncSuccess).catch(onFailure);
  }

  function onSyncSuccess(response) {
    if (response.success && response.data) {
      allData = response.data;
      console.log('Data Synced:', allData.length);
      localStorage.setItem('smartlab_local_data', JSON.stringify(allData));
      initializeDefaultAdmin();
    } else {
      onFailure(new Error('Failed to sync data or no data returned.'));
    }
  }
  
  function onCrudSuccess(response) {
    if (!response.success) {
      const specificError = response.message || 'CRUD operation failed';
      showErrorMessage(specificError); 
      onFailure(new Error(specificError));
      return;
    }
    
    // [‡πÉ‡∏´‡∏°‡πà] ‡∏Å‡∏£‡∏ì‡∏µ Batch Create (Import Excel)
    if (response.message && response.message.includes('Imported')) {
       showWelcomeToast("‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "admin"); // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ß‡∏¢‡πÜ
       
       // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
       callApi('sync').then(res => {
           if(res.success && res.data) {
               allData = res.data;
               localStorage.setItem('smartlab_local_data', JSON.stringify(allData));
               renderDashboard();
           }
       });
       closeModal();
       return;
    }

    console.log('‚úÖ CRUD Success:', response.action);
    
    if (response.action === 'create') {
      allData.push(response.data);
    } 
    else if (response.action === 'update') {
      const index = allData.findIndex(i => 
        (i.__backendId && response.data.__backendId && i.__backendId === response.data.__backendId) || 
        (i.id && response.data.id && i.id === response.data.id)
      );

      if (index > -1) {
        allData[index] = response.data;
        if (currentUser && (
            (currentUser.__backendId && currentUser.__backendId === response.data.__backendId) ||
            (currentUser.id && currentUser.id === response.data.id)
        )) {
          const displayName = (`${response.data.firstName || ''} ${response.data.lastName || ''}`).trim();
          currentUser.displayName = displayName || response.data.username;
        }
      } else {
        allData.push(response.data);
      }
    } 
    else if (response.action === 'delete') {
      allData = allData.filter(i => {
         const matchBackend = i.__backendId && response.id && i.__backendId === response.id;
         const matchId = i.id && response.id && i.id === response.id;
         return !(matchBackend || matchId);
      });
    }
    
    localStorage.setItem('smartlab_local_data', JSON.stringify(allData));
    closeModal();
    renderDashboard(); 
  }

  function onBorrowSuccess(response) {
      if (!response.success) {
        return onFailure(new Error(response.message || 'Borrow operation failed'));
      }
      
      console.log('Borrow Success:', response.action);
      
      allData.push(response.borrow);
      
      const index = allData.findIndex(i => i.__backendId === response.item.__backendId);
      if (index > -1) {
        allData[index] = response.item;
      } else {
        allData.push(response.item);
      }

      localStorage.setItem('smartlab_local_data', JSON.stringify(allData));
      closeModal();
      currentTab = 'borrow';
      renderDashboard();
    }

  function onFailure(error) {
    console.error('API Error:', error);
    const errorBox = loginErrorElement || document.querySelector('.error-toast');
    if (errorBox && !document.querySelector('.error-toast')) {
         showErrorMessage(error.message);
    }
    const modalSubmitBtn = document.querySelector('.modal-content button[type="submit"]');
    if (modalSubmitBtn) {
        modalSubmitBtn.disabled = false;
        modalSubmitBtn.textContent = modalSubmitBtn.dataset.originalText || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
    }
    if(loginButtonElement) {
        loginButtonElement.disabled = false;
        loginButtonElement.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
    }
  }

  function createItem(data) {
    console.log('Creating item...', data);
    callApi('create', data).then(onCrudSuccess).catch(onFailure);
  }

  function updateItem(data) {
    console.log('Updating item...', data);
    callApi('update', data).then(onCrudSuccess).catch(onFailure);
  }
  
  function deleteItem(backendId) {
    const item = allData.find(i => i.__backendId === backendId);
    if (!item) return;

    if(!modalElement) modalElement = document.getElementById('modal');
    modalElement.innerHTML = `
      <div class="modal-content">
        <div class="modal-header"><h3>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <div style="text-align: center; padding: 20px 0;">
          <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
          <p style="margin-bottom: 24px; color: #6b7280; font-size: 16px;">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö "<strong>${item.name || item.username}</strong>" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?<br><small>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ</small></p>
        </div>
        <div style="display: flex; gap: 12px; justify-content: center;">
          <button class="btn btn-secondary" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDelete('${backendId}')">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
      </div>
    `;
    modalElement.classList.add('active');
  }

  function confirmDelete(backendId) {
    const btn = document.getElementById('confirmDeleteBtn');
    if(btn) {
        btn.disabled = true;
        btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...';
    }
    callApi('delete', { id: backendId }).then(onCrudSuccess).catch(onFailure);
  }
  
  async function initializeDefaultAdmin() {
    const adminExists = allData.find(item => item.type === 'user' && item.username === 'admin');
    if (!adminExists) {
      const adminData = {
        id: 'admin-' + Date.now(), type: 'user', username: 'admin', password: 'admin123', role: 'admin', createdAt: new Date().toISOString()
      };
      callApi('create', adminData).then(onAdminCreated).catch(onFailure);
    } else {
      renderLogin();
    }
  }
  
  function onAdminCreated(response) {
    if (!response.success) { return onFailure(new Error('Failed to create admin user.')); }
    callApi('sync').then((syncResponse) => {
        if (syncResponse.success && syncResponse.data) {
          allData = syncResponse.data;
          renderLogin();
        } else { onFailure(new Error('Failed to sync after admin creation.')); }
    }).catch(onFailure);
  }

  function renderLogin() {
    currentView = 'login';
    const title = defaultConfig.system_title;
    const logoUrl = defaultConfig.logo_url;
    const welcomeMsg = defaultConfig.welcome_message;

    appElement.innerHTML = `
      <div class="login-container">
        <div class="login-box">
          <div class="logo-container">
            <div class="logo">${logoUrl ? `<img src="${logoUrl}" alt="Logo">` : 'üß™'}</div>
            <h1 class="system-title">${title}</h1>
            <p class="subtitle">${welcomeMsg}</p>
          </div>
          <div id="loginError"></div>
          <form id="loginForm">
            <div class="form-group"><label for="username">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label><input type="text" id="username" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"></div>
            <div class="form-group"><label for="password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><div class="input-wrapper"><input type="password" id="password" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"><span class="eye-icon" onclick="togglePassword()">${SVG_EYE_SHOW}</span></div></div>
            <button type="submit" id="loginButton" class="btn btn-primary">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
          </form>
          <div class="info-box" style="margin-top: 20px;"><p style="text-align: center; white-space: nowrap; font-size: 13px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ | ‡∏Ñ‡∏£‡∏π‡∏≠‡∏≤‡∏ô‡∏ô‡∏ó‡πå ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ß</p></div>
        </div>
      </div>
    `;

    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    loginButtonElement = document.getElementById('loginButton');
    loginErrorElement = document.getElementById('loginError');
  }

  function togglePassword() {
    const passwordInput = document.getElementById('password');
    const eyeIcon = document.querySelector('#loginForm .eye-icon'); 
    if (!passwordInput || !eyeIcon) return;
    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      eyeIcon.innerHTML = SVG_EYE_HIDE;
    } else {
      passwordInput.type = 'password';
      eyeIcon.innerHTML = SVG_EYE_SHOW;
    }
  }

  async function handleLogin(e) {
    e.preventDefault();
    if(loginButtonElement) {
      loginButtonElement.disabled = true;
      loginButtonElement.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
    }
    if(loginErrorElement) loginErrorElement.innerHTML = '';
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    callApi('login', { username: username, password: password }).then(onLoginSuccess).catch(onFailure);
  }
  
  function onLoginSuccess(response) {
    if(loginButtonElement) {
      loginButtonElement.disabled = false;
      loginButtonElement.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
    }

    if (response.success && response.user) {
      currentUser = response.user;
      const displayName = (`${currentUser.firstName || ''} ${currentUser.lastName || ''}`).trim();
      currentUser.displayName = displayName || currentUser.username; 
      currentView = currentUser.role === 'admin' ? 'admin' : 'teacher';
      currentTab = 'dashboard';
      
      showWelcomeToast(currentUser.displayName, currentUser.role);

      if (allData && allData.length > 0) {
        renderDashboard();
      } else {
        appElement.innerHTML = `<div class="login-container"><div class="login-box" style="text-align: center;"><h2>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h2></div></div>`;
        callApi('sync').then(res => {
             if(res.success && res.data) {
                 allData = res.data;
                 localStorage.setItem('smartlab_local_data', JSON.stringify(allData));
                 renderDashboard();
             }
        }).catch(onFailure);
      }

    } else {
      if(loginErrorElement) {
        loginErrorElement.innerHTML = '<div class="error-message">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>';
      }
    }
  }

  function renderDashboard() {
    if (!appElement) appElement = document.getElementById('app');
    const title = defaultConfig.system_title;
    const logoUrl = defaultConfig.logo_url;
    if (currentUser.role === 'admin') {
      renderAdminDashboard(title, logoUrl);
    } else {
      renderTeacherDashboard(title, logoUrl);
    }
    modalElement = document.getElementById('modal');
  }

  function renderAdminDashboard(title, logoUrl) {
    const chemicals = allData.filter(item => item.type === 'chemical');
    const equipment = allData.filter(item => item.type === 'equipment');
    const users = allData.filter(item => item.type === 'user' && item.role === 'teacher');
    const lowStockChemicals = chemicals.filter(item => item.quantity <= (item.minStock || 0));
    const lowStockEquipment = equipment.filter(item => item.quantity <= (item.minStock || 0));
    const totalLowStock = lowStockChemicals.length + lowStockEquipment.length; 

    appElement.innerHTML = `
      <div class="container">
        <div class="header">
          <div class="header-left">
            <div class="header-logo">${logoUrl ? `<img src="${logoUrl}" alt="Logo">` : 'üß™'}</div>
            <div class="header-info"><h2 class="system-title">${title}</h2><p>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö: ${currentUser.displayName}</p></div>
          </div>
          <!-- ‡∏õ‡∏∏‡πà‡∏° logout ‡∏™‡∏µ‡πÅ‡∏î‡∏á -->
          <div class="header-right"><button class="btn btn-secondary btn-small btn-logout" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button></div>
        </div>
        <div class="nav-tabs">
          <button class="nav-tab ${currentTab === 'dashboard' ? 'active' : ''}" onclick="switchTab('dashboard')">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</button>
          <button class="nav-tab ${currentTab === 'chemicals' ? 'active' : ''}" onclick="switchTab('chemicals')">üß¨ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</button>
          <button class="nav-tab ${currentTab === 'equipment' ? 'active' : ''}" onclick="switchTab('equipment')">üî¨ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
          <button class="nav-tab ${currentTab === 'users' ? 'active' : ''}" onclick="switchTab('users')">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
          <button class="nav-tab ${currentTab === 'reports' ? 'active' : ''}" onclick="switchTab('reports')">üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
        </div>
        
        <div id="dashboardSection" class="content-section ${currentTab === 'dashboard' ? 'active' : ''}">
          <div class="stats-grid">
            <div class="stat-card"><h3>‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><p class="number">${chemicals.length}</p></div>
            <div class="stat-card"><h3>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><p class="number">${equipment.length}</p></div>
            <div class="stat-card"><h3>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3><p class="number">${users.length}</p></div>
            <div class="stat-card"><h3>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥</h3><p class="number" style="color: #dc2626;">${totalLowStock}</p></div>
          </div>
          ${lowStockChemicals.length > 0 ? `
            <div class="card"><div class="academic-header"><h3>üß¨ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥ (‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ)</h3></div><div class="table-container"><table><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</th><th>‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö</th></tr></thead><tbody>${lowStockChemicals.map(item => `<tr><td><strong>${item.name}</strong></td><td>${item.formula || '-'}</td><td><span class="badge badge-low">${item.quantity} ${item.unit}</span></td><td>${item.minStock || 0} ${item.unit}</td><td>${item.location}</td></tr>`).join('')}</tbody></table></div></div>
          ` : ''}
          ${lowStockEquipment.length > 0 ? `
            <div class="card"><div class="academic-header"><h3>üî¨ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥ (‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå)</h3></div><div class="table-container"><table><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö</th></tr></thead><tbody>${lowStockEquipment.map(item => `<tr><td><strong>${item.name}</strong></td><td><span class="badge badge-low">${item.quantity} ${item.unit}</span></td><td>${item.minStock || 0} ${item.unit}</td><td>${item.location}</td></tr>`).join('')}</tbody></table></div></div>
          ` : ''}
          ${totalLowStock === 0 ? `<div class="card"><div class="empty-state" style="padding: 40px 20px;"><div class="empty-state-icon" style="font-size: 48px; margin-bottom: 16px;">‚úÖ</div><span style="color: #6b7280;">‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°!</span><br>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥</div></div>` : ''}
        </div>
        <div id="chemicalsSection" class="content-section ${currentTab === 'chemicals' ? 'active' : ''}">${renderChemicalsSection()}</div>
        <div id="equipmentSection" class="content-section ${currentTab === 'equipment' ? 'active' : ''}">${renderEquipmentSection()}</div>
        <div id="usersSection" class="content-section ${currentTab === 'users' ? 'active' : ''}">${renderUsersSection()}</div>
        <div id="reportsSection" class="content-section ${currentTab === 'reports' ? 'active' : ''}">${renderReportsSection()}</div>
        <div class="page-footer">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏≠‡∏≤‡∏ô‡∏ô‡∏ó‡πå ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ß</div>
      </div>
      <div id="modal" class="modal"></div>
    `;
    modalElement = document.getElementById('modal');
  }

  function renderChemicalsSection() {
    const chemicals = allData.filter(item => item.type === 'chemical');
    return `
      <div class="card">
        <div class="academic-header"><h3>üß¨ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</h3></div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
          <div class="info-box" style="flex: 1; margin: 0;"><p>üìã ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${chemicals.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div>
          <div style="display: flex; gap: 8px;">
            <!-- [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel -->
            <button class="btn btn-success btn-small" onclick="document.getElementById('excelInput').click()">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel</button>
            <button class="btn btn-primary btn-small" onclick="openAddChemicalModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</button>
          </div>
        </div>
        <div class="search-box"><input type="text" id="chemicalSearch" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ (‡∏ä‡∏∑‡πà‡∏≠, ‡∏™‡∏π‡∏ï‡∏£, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö)..." onkeyup="filterChemicals()"></div>
        <div class="table-container academic-table">
          <table id="chemicalsTable">
            <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</th><th>‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö</th><th>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
            <tbody>
              ${chemicals.length > 0 ? chemicals.map(item => `
                <tr>
                  <td><strong>${item.name}</strong></td>
                  <td>${item.formula || '-'}</td>
                  <td><span class="badge ${item.quantity <= (item.minStock || 0) ? 'badge-low' : 'badge-normal'}">${item.quantity}</span></td>
                  <td>${item.unit}</td>
                  <td>${item.location}</td>
                  <td>${item.minStock || 0}</td>
                  <td>
                    <button class="btn btn-secondary btn-small" onclick='editChemical(${JSON.stringify(item)})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="btn btn-danger btn-small" onclick='deleteItem("${item.__backendId}")'>‡∏•‡∏ö</button>
                  </td>
                </tr>
              `).join('') : '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üìã</div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ<br><small>‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</small></td></tr>'}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }

  // --- [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Excel ---
  function handleExcelUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const rawData = XLSX.utils.sheet_to_json(firstSheet);

      // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Excel ‡πÄ‡∏õ‡πá‡∏ô Format ‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö
      const chemicals = rawData.map((row, index) => {
        return {
          id: 'chem-' + Date.now() + '-' + index,
          type: 'chemical',
          name: row['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ'] || row['Name'] || '',
          formula: row['‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ'] || row['Formula'] || '',
          quantity: parseFloat(row['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'] || row['Quantity'] || 0),
          unit: row['‡∏´‡∏ô‡πà‡∏ß‡∏¢'] || row['Unit'] || '‡∏´‡∏ô‡πà‡∏ß‡∏¢',
          location: row['‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö'] || row['Location'] || '-',
          minStock: parseFloat(row['‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥'] || row['MinStock'] || 0),
          createdAt: new Date().toISOString()
        };
      }).filter(item => item.name); // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠

      if (chemicals.length === 0) {
        showErrorMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return;
      }

      // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤
      if(!modalElement) modalElement = document.getElementById('modal');
      modalElement.innerHTML = `
        <div class="modal-content">
          <div class="modal-header"><h3>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3><button class="close-btn" onclick="closeModal()">√ó</button></div>
          <div style="text-align: center; padding: 20px;">
            <div style="font-size: 40px; margin-bottom: 10px;">üì•</div>
            <p>‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <strong>${chemicals.length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
            <p style="font-size: 13px; color: #6b7280;">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
          </div>
          <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn btn-secondary" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button class="btn btn-success" id="confirmImportBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button>
          </div>
        </div>
      `;
      modalElement.classList.add('active');

      document.getElementById('confirmImportBtn').onclick = function() {
        const btn = this;
        btn.disabled = true;
        btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤...';
        
        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏õ‡∏ó‡∏µ‡πà Backend ‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (Batch Create)
        callApi('batchCreate', chemicals)
          .then(onCrudSuccess)
          .catch(onFailure);
      };
    };
    reader.readAsArrayBuffer(file);
    event.target.value = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤ input
  }

  function renderInventoryReportStats(chemicals, equipment) {
    return `
      <div class="stats-grid" style="margin-bottom: 20px;">
        <div class="stat-card"><h3>‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><p class="number">${chemicals.length}</p></div>
        <div class="stat-card"><h3>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><p class="number">${equipment.length}</p></div>
        <div class="stat-card"><h3>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥</h3><p class="number" style="color: #d97706;">${[...chemicals, ...equipment].filter(item => item.quantity <= (item.minStock || 0)).length}</p></div>
      </div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 20px;">
        <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid #bfdbfe; padding: 16px; border-radius: 12px;">
          <h4 style="margin: 0 0 12px 0; color: #1f2937; font-size: 16px;">üìä ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</h4>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 14px; font-weight: 500;">üß¨ ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ:</span><div><button class="btn btn-success btn-small" onclick="downloadInventoryReport('all_chemicals', 'excel')">Excel</button><button class="btn btn-info btn-small" onclick="downloadInventoryReport('all_chemicals', 'doc')">Word</button><button class="btn btn-danger btn-small" onclick="downloadInventoryReport('all_chemicals', 'pdf')">PDF</button></div></div>
            <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #cce7fe; padding-top: 10px;"><span style="font-size: 14px; font-weight: 500;">üî¨ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</span><div><button class="btn btn-success btn-small" onclick="downloadInventoryReport('all_equipment', 'excel')">Excel</button><button class="btn btn-info btn-small" onclick="downloadInventoryReport('all_equipment', 'doc')">Word</button><button class="btn btn-danger btn-small" onclick="downloadInventoryReport('all_equipment', 'pdf')">PDF</button></div></div>
          </div>
        </div>
        <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid #bbf7d0; padding: 16px; border-radius: 12px;">
          <h4 style="margin: 0 0 12px 0; color: #1f2937; font-size: 16px;">‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠)</h4>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 14px; font-weight: 500;">üß¨ ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ:</span><div><button class="btn btn-success btn-small" onclick="downloadInventoryReport('available_chemicals', 'excel')">Excel</button><button class="btn btn-info btn-small" onclick="downloadInventoryReport('available_chemicals', 'doc')">Word</button><button class="btn btn-danger btn-small" onclick="downloadInventoryReport('available_chemicals', 'pdf')">PDF</button></div></div>
            <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #d1f7e1; padding-top: 10px;"><span style="font-size: 14px; font-weight: 500;">üî¨ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</span><div><button class="btn btn-success btn-small" onclick="downloadInventoryReport('available_equipment', 'excel')">Excel</button><button class="btn btn-info btn-small" onclick="downloadInventoryReport('available_equipment', 'doc')">Word</button><button class="btn btn-danger btn-small" onclick="downloadInventoryReport('available_equipment', 'pdf')">PDF</button></div></div>
          </div>
        </div>
        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #f59e0b; padding: 16px; border-radius: 12px;">
          <h4 style="margin: 0 0 12px 0; color: #1f2937; font-size: 16px;">‚ö†Ô∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î (‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°)</h4>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center;"><span style="font-size: 14px; font-weight: 500;">üß¨ ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ:</span><div><button class="btn btn-success btn-small" onclick="downloadInventoryReport('reorder_chemicals', 'excel')">Excel</button><button class="btn btn-info btn-small" onclick="downloadInventoryReport('reorder_chemicals', 'doc')">Word</button><button class="btn btn-danger btn-small" onclick="downloadInventoryReport('reorder_chemicals', 'pdf')">PDF</button></div></div>
            <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f6e0b7; padding-top: 10px;"><span style="font-size: 14px; font-weight: 500;">üî¨ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</span><div><button class="btn btn-success btn-small" onclick="downloadInventoryReport('reorder_equipment', 'excel')">Excel</button><button class="btn btn-info btn-small" onclick="downloadInventoryReport('reorder_equipment', 'doc')">Word</button><button class="btn btn-danger btn-small" onclick="downloadInventoryReport('reorder_equipment', 'pdf')">PDF</button></div></div>
          </div>
        </div>
      </div>
    `;
  }

  // ... (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ renderEquipmentSection, renderUsersSection, renderReportsSection, renderIssueReportTable, renderTeacherDashboard ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ...

  function downloadInventoryReport(type, format) {
    const chemicals = allData.filter(item => item.type === 'chemical');
    const equipment = allData.filter(item => item.type === 'equipment');
    let reportData = [];
    let title = '';
    let filename = '';
    let headers = null;

    switch (type) {
      case 'all_chemicals': {
        reportData = chemicals.map(item => ({ '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ': item.name, '‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ': item.formula || '-', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠': item.quantity, '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥': item.minStock || 0, '‡∏´‡∏ô‡πà‡∏ß‡∏¢': item.unit, '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö': item.location, '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': item.quantity <= (item.minStock || 0) ? '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥' : '‡∏õ‡∏Å‡∏ï‡∏¥' }));
        title = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
        filename = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}`;
        headers = ['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ', '‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥', '‡∏´‡∏ô‡πà‡∏ß‡∏¢', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'];
        break;
      }
      case 'all_equipment': {
        reportData = equipment.map(item => ({ '‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå': item.name, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠': item.quantity, '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥': item.minStock || 0, '‡∏´‡∏ô‡πà‡∏ß‡∏¢': item.unit, '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö': item.location, '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': item.quantity <= (item.minStock || 0) ? '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥' : '‡∏õ‡∏Å‡∏ï‡∏¥' }));
        title = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
        filename = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}`;
        headers = ['‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥', '‡∏´‡∏ô‡πà‡∏ß‡∏¢', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'];
        break;
      }
      case 'available_chemicals': {
        const availableChemicals = chemicals.filter(item => item.quantity > 0);
        reportData = availableChemicals.map(item => ({ '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ': item.name, '‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ': item.formula || '-', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠': item.quantity, '‡∏´‡∏ô‡πà‡∏ß‡∏¢': item.unit, '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö': item.location }));
        title = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠';
        filename = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}`;
        headers = ['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ', '‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '‡∏´‡∏ô‡πà‡∏ß‡∏¢', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö'];
        break;
      }
      case 'available_equipment': {
        const availableEquipment = equipment.filter(item => item.quantity > 0);
        reportData = availableEquipment.map(item => ({ '‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå': item.name, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠': item.quantity, '‡∏´‡∏ô‡πà‡∏ß‡∏¢': item.unit, '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö': item.location }));
        title = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠';
        filename = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}`;
        headers = ['‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '‡∏´‡∏ô‡πà‡∏ß‡∏¢', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö'];
        break;
      }
      case 'reorder_chemicals': {
        title = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°';
        filename = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ-‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}`;
        const reorderItems = chemicals.filter(item => item.quantity <= (item.minStock || 0));
        reportData = reorderItems.map(item => ({ '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ': item.name, '‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ': item.formula || '-', '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥': item.minStock || 0, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠': item.quantity, '‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢)': Math.max(0, (item.minStock || 0) - item.quantity + 1), '‡∏´‡∏ô‡πà‡∏ß‡∏¢': item.unit }));
        headers = ['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ', '‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ', '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢)', '‡∏´‡∏ô‡πà‡∏ß‡∏¢'];
        break;
      }
      case 'reorder_equipment': {
        title = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°';
        filename = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå-‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}`;
        const reorderItems = equipment.filter(item => item.quantity <= (item.minStock || 0));
        reportData = reorderItems.map(item => ({ '‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå': item.name, '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥': item.minStock || 0, '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠': item.quantity, '‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢)': Math.max(0, (item.minStock || 0) - item.quantity + 1), '‡∏´‡∏ô‡πà‡∏ß‡∏¢': item.unit }));
        headers = ['‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', '‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢)', '‡∏´‡∏ô‡πà‡∏ß‡∏¢'];
        break;
      }
    }
    
    if (reportData.length === 0) {
        showErrorMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
        return;
    }
    if (format === 'excel') {
        downloadExcel(reportData, filename);
    } else if (format === 'pdf') {
        downloadPDF(reportData, title, filename, headers); 
    } else if (format === 'doc') {
        // [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Download Doc
        downloadDoc(reportData, title, filename, headers);
    }
  }

  // --- [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Word ---
  function downloadDoc(data, title, filename, headers) {
    let html = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
    <head><meta charset='utf-8'><title>${title}</title>
    <style>body{font-family:'Sarabun',sans-serif;} table{border-collapse:collapse;width:100%;} th,td{border:1px solid #000;padding:8px;text-align:left;}</style>
    </head><body><h2 style="text-align:center">${defaultConfig.system_title}</h2><h3 style="text-align:center">${title}</h3>
    <table><thead><tr>`;
    
    headers.forEach(h => html += `<th style="background:#e0e0e0">${h}</th>`);
    html += `</tr></thead><tbody>`;
    
    data.forEach(row => {
        html += `<tr>`;
        headers.forEach(h => html += `<td>${row[h]}</td>`);
        html += `</tr>`;
    });
    
    html += `</tbody></table></body></html>`;
    
    const blob = new Blob(['\ufeff', html], {
        type: 'application/msword'
    });
    
    const url = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(html);
    const link = document.createElement("a");
    document.body.appendChild(link);
    if(navigator.msSaveOrOpenBlob ){ navigator.msSaveOrOpenBlob( blob, `${filename}.doc`); }
    else { link.href = url; link.download = `${filename}.doc`; link.click(); }
    document.body.removeChild(link);
  }

  function downloadExcel(data, filename) {
    if (data.length === 0) {
      showErrorMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
      return;
    }
    const headers = Object.keys(data[0]);
    const csvContent = [
      headers.join(','),
      ...data.map(row => headers.map(header => {
        const value = row[header];
        if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
          return `"${value.replace(/"/g, '""')}"`;
        }
        return value;
      }).join(','))
    ].join('\n');
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `${filename}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function downloadPDF(data, title, filename, headers = null) {
    const hasData = Array.isArray(data) ? data.length > 0 : false;
    if (!hasData) {
      showErrorMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î');
      return;
    }
    const systemTitle = defaultConfig.system_title;
    const printWindow = window.open('', '_blank');
    printWindow.document.write('<html><head><title>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...</title><style>body{font-family: Sarabun, sans-serif; text-align: center; padding-top: 50px;} h2{color: #60a5fa;}</style></head><body><h2>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå...</h2><p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p></body></html>');
    printWindow.document.close();

    callApi('getPdf', { reportData: data, title, systemTitle, headers })
      .then(response => {
        if (!response.html) { throw new Error('No HTML content returned'); }
        printWindow.document.open();
        printWindow.document.write(response.html);
        printWindow.document.close();
        printWindow.onload = function() { setTimeout(() => { printWindow.focus(); printWindow.print(); }, 500); };
      })
      .catch(error => { printWindow.close(); onFailure(error); });
  }

  function showWelcomeToast(name, role) {
    const existingToast = document.querySelector('.welcome-toast');
    if (existingToast) existingToast.remove();

    const icon = role === 'admin' ? 'üë®‚Äçüíª' : 'üë®‚Äçüè´';
    const roleText = role === 'admin' ? '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö' : '‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô';

    const toast = document.createElement('div');
    toast.className = 'welcome-toast';
    toast.innerHTML = `
      <div class="welcome-icon-circle">${icon}</div>
      <div class="welcome-content">
          <span class="welcome-title">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, ${roleText}</span>
          <span class="welcome-name">${name}</span>
      </div>
    `;

    document.body.appendChild(toast);
    requestAnimationFrame(() => { toast.classList.add('show'); });
    setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 600); }, 3500);
  }
</script>
 </body>
</html>
